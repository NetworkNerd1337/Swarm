{% extends "base.html" %}

{% block title %}Predictive Analytics - StreamSwarm{% endblock %}

{% block extra_head %}
<style>
.prediction-card {
    transition: all 0.3s ease;
    border: 1px solid #dee2e6;
}

.prediction-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transform: translateY(-2px);
}

.performance-indicator {
    font-size: 2.5rem;
    font-weight: bold;
}

.confidence-bar {
    height: 8px;
    border-radius: 4px;
    overflow: hidden;
}

.insight-item {
    border-left: 4px solid #007bff;
    padding-left: 12px;
    margin-bottom: 8px;
}

.trend-arrow {
    font-size: 1.2rem;
    margin-left: 8px;
}

.capacity-metric {
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.loading-spinner {
    display: none;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #007bff;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    animation: spin 1s linear infinite;
    margin: 0 auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <h1 class="h2 mb-3">
                <i class="fas fa-crystal-ball me-2"></i>
                Predictive Analytics
            </h1>
            <p class="text-muted">AI-powered performance forecasting and capacity planning</p>
        </div>
        <div class="col-auto">
            <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>
                Back to Dashboard
            </a>
        </div>
    </div>

    <!-- Performance Prediction Section -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card prediction-card">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        Performance Prediction
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="mb-3">Test Configuration</h6>
                            <form id="predictionForm">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="destination" class="form-label">Destination</label>
                                        <input type="text" class="form-control" id="destination" value="google.com" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="packetSize" class="form-label">Packet Size (bytes)</label>
                                        <select class="form-select" id="packetSize">
                                            <option value="64">64 (Standard)</option>
                                            <option value="128">128</option>
                                            <option value="256">256</option>
                                            <option value="512">512</option>
                                            <option value="1024">1024</option>
                                            <option value="1472">1472 (MTU)</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="testCount" class="form-label">Test Count</label>
                                        <select class="form-select" id="testCount">
                                            <option value="4">4 (Quick)</option>
                                            <option value="10" selected>10 (Standard)</option>
                                            <option value="20">20 (Detailed)</option>
                                            <option value="50">50 (Comprehensive)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="testType" class="form-label">Test Type</label>
                                        <select class="form-select" id="testType">
                                            <option value="basic">Basic Ping</option>
                                            <option value="comprehensive" selected>Comprehensive</option>
                                            <option value="bandwidth">Bandwidth Focus</option>
                                        </select>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-magic me-2"></i>
                                    Predict Performance
                                </button>
                            </form>
                        </div>
                        
                        <div class="col-md-6">
                            <div id="predictionResults" style="display: none;">
                                <h6 class="mb-3">Prediction Results</h6>
                                
                                <!-- Performance Category -->
                                <div class="text-center mb-4">
                                    <div id="performanceCategory" class="performance-indicator text-success">
                                        Excellent
                                    </div>
                                    <div id="predictedLatency" class="h4 text-muted">
                                        ~25ms
                                    </div>
                                </div>
                                
                                <!-- Confidence Score -->
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="small">Confidence Score</span>
                                        <span id="confidenceScore" class="small fw-bold">85%</span>
                                    </div>
                                    <div class="confidence-bar bg-light">
                                        <div id="confidenceBar" class="bg-success" style="width: 85%; height: 100%;"></div>
                                    </div>
                                </div>
                                
                                <!-- Insights -->
                                <div id="predictionInsights">
                                    <h6 class="mb-2">AI Insights</h6>
                                    <div id="insightsList">
                                        <!-- Insights will be populated here -->
                                    </div>
                                </div>
                            </div>
                            
                            <div id="predictionLoading" class="loading-spinner"></div>
                            
                            <div id="predictionError" class="alert alert-warning" style="display: none;">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <span id="errorMessage">Prediction model not available</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Network Failure Prediction Section -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card prediction-card">
                <div class="card-header bg-danger text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Network Failure Prediction
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="mb-3">Configuration</h6>
                            <form id="failurePredictionForm">
                                <div class="row">
                                    <div class="col-md-12 mb-3">
                                        <label for="failureDestination" class="form-label">Target Destination</label>
                                        <select class="form-select" id="failureDestination" required>
                                            <option value="">Select destination with historical data...</option>
                                            <option value="tiktok.com">tiktok.com (587 measurements)</option>
                                            <option value="vimeo.com/groups/639164/videos/297263163?autoplay=1">vimeo.com (291 measurements)</option>
                                            <option value="yahoo.com">yahoo.com (259 measurements)</option>
                                            <option value="mfa.gov.ua/en">mfa.gov.ua/en (252 measurements)</option>
                                            <option value="spiegel.de">spiegel.de (153 measurements)</option>
                                            <option value="YouTube.com">YouTube.com (135 measurements)</option>
                                            <option value="ryanthomashuff.com">ryanthomashuff.com (102 measurements)</option>
                                            <option value="Snapchat.com">Snapchat.com (92 measurements)</option>
                                            <option value="flipkart.com">flipkart.com (64 measurements)</option>
                                            <option value="sports.yahoo.co.jp">sports.yahoo.co.jp (62 measurements)</option>
                                        </select>
                                        <div class="form-text">Only destinations with 15+ historical measurements support failure prediction</div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="predictionHorizon" class="form-label">Prediction Horizon</label>
                                        <select class="form-select" id="predictionHorizon">
                                            <option value="6">Next 6 hours</option>
                                            <option value="12">Next 12 hours</option>
                                            <option value="24" selected>Next 24 hours</option>
                                            <option value="48">Next 48 hours</option>
                                            <option value="72">Next 72 hours</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="currentConditions" class="form-label">Current Network State</label>
                                        <select class="form-select" id="currentConditions">
                                            <option value="normal" selected>Normal operations</option>
                                            <option value="stressed">Under stress</option>
                                            <option value="degraded">Degraded performance</option>
                                            <option value="maintenance">Maintenance mode</option>
                                        </select>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-danger">
                                    <i class="fas fa-search me-2"></i>
                                    Predict Failure Risk
                                </button>
                            </form>
                        </div>
                        
                        <div class="col-md-6">
                            <div id="failurePredictionResults" style="display: none;">
                                <h6 class="mb-3">Failure Risk Assessment</h6>
                                
                                <!-- Risk Level Display -->
                                <div class="text-center mb-4">
                                    <div id="riskLevel" class="performance-indicator text-warning">
                                        MODERATE
                                    </div>
                                    <div id="failureProbability" class="h4 text-muted">
                                        15% probability
                                    </div>
                                    <small class="text-muted">Within <span id="timeHorizon">24</span> hours</small>
                                </div>
                                
                                <!-- Confidence Score -->
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="small">Model Confidence</span>
                                        <span id="failureConfidenceScore" class="small fw-bold">78%</span>
                                    </div>
                                    <div class="confidence-bar bg-light">
                                        <div id="failureConfidenceBar" class="bg-info" style="width: 78%; height: 100%;"></div>
                                    </div>
                                </div>
                                
                                <!-- Contributing Factors -->
                                <div class="mb-3">
                                    <h6 class="mb-2">Risk Factors</h6>
                                    <div id="riskFactorsList">
                                        <!-- Risk factors will be populated here -->
                                    </div>
                                </div>
                                
                                <!-- Recommendations -->
                                <div id="failureRecommendations">
                                    <h6 class="mb-2">Prevention Actions</h6>
                                    <div id="recommendationsList">
                                        <!-- Recommendations will be populated here -->
                                    </div>
                                </div>
                            </div>
                            
                            <div id="failurePredictionLoading" class="loading-spinner"></div>
                            
                            <div id="failurePredictionError" class="alert alert-warning" style="display: none;">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <span id="failureErrorMessage">Failure prediction model not available</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Capacity Planning Section -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-area me-2"></i>
                        Capacity Planning & Trends
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="analysisPeriod" class="form-label">Analysis Period</label>
                            <select class="form-select" id="analysisPeriod">
                                <option value="7">Last 7 days</option>
                                <option value="14">Last 2 weeks</option>
                                <option value="30" selected>Last 30 days</option>
                                <option value="60">Last 60 days</option>
                                <option value="90">Last 90 days</option>
                            </select>
                        </div>
                        <div class="col-md-6 d-flex align-items-end">
                            <button id="analyzeTrends" class="btn btn-info">
                                <i class="fas fa-chart-line me-2"></i>
                                Analyze Trends
                            </button>
                        </div>
                    </div>
                    
                    <div id="trendsResults" style="display: none;">
                        <!-- Network Health Trend -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div id="healthTrend" class="capacity-metric bg-dark text-light">
                                    <h6 class="mb-2 text-light">
                                        <i class="fas fa-heartbeat me-2"></i>
                                        Overall Network Health
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="text-center">
                                                <div id="currentHealthScore" class="h3 text-success">85.2</div>
                                                <small class="text-light">Current Score</small>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="text-center">
                                                <div id="healthTrendDirection" class="h5 text-light">
                                                    Stable <span class="trend-arrow text-warning">↔</span>
                                                </div>
                                                <small class="text-light">Trend</small>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="text-center">
                                                <div id="healthChange" class="h5 text-success">+2.1%</div>
                                                <small class="text-light">Change</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Individual Metrics -->
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <div id="latencyTrend" class="capacity-metric">
                                    <h6 class="mb-2">
                                        <i class="fas fa-clock me-2"></i>
                                        Latency Trend
                                    </h6>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span id="latencyStatus" class="badge bg-success">Improving</span>
                                        <span id="latencyChange" class="fw-bold">-5.2%</span>
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted">Avg: <span id="latencyAvg">42ms</span></small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <div id="bandwidthTrend" class="capacity-metric">
                                    <h6 class="mb-2">
                                        <i class="fas fa-download me-2"></i>
                                        Bandwidth Trend
                                    </h6>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span id="bandwidthStatus" class="badge bg-warning">Stable</span>
                                        <span id="bandwidthChange" class="fw-bold">+1.1%</span>
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted">Avg: <span id="bandwidthAvg">245 Mbps</span></small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <div id="packetLossTrend" class="capacity-metric">
                                    <h6 class="mb-2">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        Packet Loss Trend
                                    </h6>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span id="packetLossStatus" class="badge bg-success">Improving</span>
                                        <span id="packetLossChange" class="fw-bold">-0.3%</span>
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted">Avg: <span id="packetLossAvg">0.8%</span></small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Recommendations -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">
                                            <i class="fas fa-lightbulb me-2"></i>
                                            Capacity Planning Recommendations
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="recommendationsList">
                                            <!-- Recommendations will be populated here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="trendsLoading" class="loading-spinner"></div>
                    
                    <div id="trendsError" class="alert alert-warning" style="display: none;">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span id="trendsErrorMessage">Insufficient data for trend analysis</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- QoS Compliance Monitoring Section -->
<div class="row mb-5">
    <div class="col-12">
        <div class="card prediction-card">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-network-wired me-2"></i>QoS Compliance Monitoring
                </h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="qosDestination" class="form-label">Destination</label>
                        <input type="text" class="form-control" id="qosDestination" placeholder="e.g., google.com">
                    </div>
                    <div class="col-md-6">
                        <label for="qosTestId" class="form-label">Test ID (Optional)</label>
                        <input type="number" class="form-control" id="qosTestId" placeholder="Leave blank for destination analysis">
                    </div>
                </div>
                
                <button type="button" class="btn btn-info" onclick="analyzeQoSCompliance()">
                    <i class="fas fa-chart-line me-2"></i>Analyze QoS Compliance
                </button>
                
                <!-- Loading Spinner -->
                <div id="qosLoading" class="loading-spinner mx-auto mt-3" style="display: none;"></div>
                
                <!-- Error Display -->
                <div id="qosError" class="alert alert-danger mt-3" style="display: none;">
                    <strong>Analysis Failed:</strong> <span id="qosErrorMessage"></span>
                </div>
                
                <!-- Results Display -->
                <div id="qosResults" class="mt-4" style="display: none;">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="text-center p-3 bg-light rounded">
                                <h3 id="qosComplianceScore" class="performance-indicator text-info">-</h3>
                                <p class="mb-0 text-muted">Overall Compliance</p>
                                <small id="qosComplianceLevel" class="text-success">-</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center p-3 bg-light rounded">
                                <h3 id="qosConfidence" class="performance-indicator text-secondary">-</h3>
                                <p class="mb-0 text-muted">Confidence Score</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center p-3 bg-light rounded">
                                <h3 id="qosSamples" class="performance-indicator text-primary">-</h3>
                                <p class="mb-0 text-muted">Analyzed Samples</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Compliance Distribution -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6>Compliance Distribution</h6>
                            <div class="progress mb-2" style="height: 20px;">
                                <div id="qosFullyCompliant" class="progress-bar bg-success" role="progressbar"></div>
                                <div id="qosPartiallyCompliant" class="progress-bar bg-warning" role="progressbar"></div>
                                <div id="qosNonCompliant" class="progress-bar bg-danger" role="progressbar"></div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <small class="text-success">Fully Compliant</small>
                                <small class="text-warning">Partially Compliant</small>
                                <small class="text-danger">Non-Compliant</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- QoS Insights -->
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h6>DSCP Analysis</h6>
                            <div id="qosDscpAnalysis" class="bg-light p-3 rounded" style="max-height: 200px; overflow-y: auto;">
                                <!-- DSCP analysis will be populated here -->
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Traffic Violations</h6>
                            <div id="qosViolations" class="bg-light p-3 rounded" style="max-height: 200px; overflow-y: auto;">
                                <!-- Violations will be populated here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- QoS Recommendations -->
                    <div class="mt-3">
                        <h6>QoS Recommendations</h6>
                        <div id="qosRecommendations" class="bg-light p-3 rounded">
                            <!-- Recommendations will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Performance Prediction
document.getElementById('predictionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const predictionResults = document.getElementById('predictionResults');
    const predictionLoading = document.getElementById('predictionLoading');
    const predictionError = document.getElementById('predictionError');
    
    // Hide previous results
    predictionResults.style.display = 'none';
    predictionError.style.display = 'none';
    predictionLoading.style.display = 'block';
    
    const formData = {
        test_config: {
            destination: document.getElementById('destination').value,
            packet_size: parseInt(document.getElementById('packetSize').value),
            test_count: parseInt(document.getElementById('testCount').value),
            test_type: document.getElementById('testType').value
        },
        current_conditions: {
            // Add current system conditions if available
        }
    };
    
    fetch('/api/predict-performance', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        predictionLoading.style.display = 'none';
        
        if (data.status === 'success') {
            displayPredictionResults(data);
            predictionResults.style.display = 'block';
        } else {
            document.getElementById('errorMessage').textContent = data.error || 'Prediction failed';
            predictionError.style.display = 'block';
        }
    })
    .catch(error => {
        predictionLoading.style.display = 'none';
        document.getElementById('errorMessage').textContent = 'Network error: ' + error.message;
        predictionError.style.display = 'block';
    });
});

function displayPredictionResults(data) {
    // Performance Category
    const categoryElement = document.getElementById('performanceCategory');
    const latencyElement = document.getElementById('predictedLatency');
    
    const categoryColors = {
        'excellent': 'text-success',
        'good': 'text-info',
        'fair': 'text-warning',
        'poor': 'text-warning',
        'critical': 'text-danger'
    };
    
    categoryElement.className = `performance-indicator ${categoryColors[data.performance_category] || 'text-secondary'}`;
    categoryElement.textContent = data.performance_category.charAt(0).toUpperCase() + data.performance_category.slice(1);
    latencyElement.textContent = `~${Math.round(data.predicted_latency_ms)}ms`;
    
    // Confidence Score
    const confidencePercent = Math.round(data.confidence_score * 100);
    document.getElementById('confidenceScore').textContent = `${confidencePercent}%`;
    document.getElementById('confidenceBar').style.width = `${confidencePercent}%`;
    
    const confidenceColors = confidencePercent >= 80 ? 'bg-success' : confidencePercent >= 60 ? 'bg-warning' : 'bg-danger';
    document.getElementById('confidenceBar').className = confidenceColors;
    
    // Insights
    const insightsList = document.getElementById('insightsList');
    insightsList.innerHTML = '';
    
    if (data.insights && data.insights.length > 0) {
        data.insights.forEach(insight => {
            const insightDiv = document.createElement('div');
            insightDiv.className = 'insight-item';
            insightDiv.innerHTML = `<small>${insight}</small>`;
            insightsList.appendChild(insightDiv);
        });
    } else {
        insightsList.innerHTML = '<small class="text-muted">No specific insights available</small>';
    }
}

// Capacity Trends Analysis
document.getElementById('analyzeTrends').addEventListener('click', function() {
    const days = document.getElementById('analysisPeriod').value;
    const trendsResults = document.getElementById('trendsResults');
    const trendsLoading = document.getElementById('trendsLoading');
    const trendsError = document.getElementById('trendsError');
    
    // Hide previous results
    trendsResults.style.display = 'none';
    trendsError.style.display = 'none';
    trendsLoading.style.display = 'block';
    
    fetch(`/api/capacity-trends?days=${days}`)
    .then(response => response.json())
    .then(data => {
        trendsLoading.style.display = 'none';
        
        if (data.status === 'success') {
            displayTrendsResults(data);
            trendsResults.style.display = 'block';
        } else {
            document.getElementById('trendsErrorMessage').textContent = data.error || 'Trends analysis failed';
            trendsError.style.display = 'block';
        }
    })
    .catch(error => {
        trendsLoading.style.display = 'none';
        document.getElementById('trendsErrorMessage').textContent = 'Network error: ' + error.message;
        trendsError.style.display = 'block';
    });
});

function displayTrendsResults(data) {
    // Health Trend
    if (data.health_trend) {
        document.getElementById('currentHealthScore').textContent = data.health_trend.current_score || '0';
        
        const trendDirection = data.health_trend.trend || 'stable';
        const trendSymbols = {
            'improving': '↗',
            'degrading': '↘',
            'stable': '↔'
        };
        const trendColors = {
            'improving': 'text-success',
            'degrading': 'text-danger',
            'stable': 'text-warning'
        };
        
        const trendElement = document.getElementById('healthTrendDirection');
        trendElement.innerHTML = `${trendDirection.charAt(0).toUpperCase() + trendDirection.slice(1)} <span class="trend-arrow ${trendColors[trendDirection]}">${trendSymbols[trendDirection]}</span>`;
        
        const changePercent = data.health_trend.change_percent || 0;
        document.getElementById('healthChange').textContent = `${changePercent > 0 ? '+' : ''}${changePercent}%`;
        document.getElementById('healthChange').className = `h5 ${changePercent > 0 ? 'text-success' : changePercent < 0 ? 'text-danger' : 'text-muted'}`;
    }
    
    // Individual Metrics
    if (data.trends) {
        updateMetricTrend('latency', data.trends.latency);
        updateMetricTrend('bandwidth', data.trends.bandwidth);
        updateMetricTrend('packetLoss', data.trends.packet_loss);
    }
    
    // Recommendations
    const recommendationsList = document.getElementById('recommendationsList');
    recommendationsList.innerHTML = '';
    
    if (data.recommendations && data.recommendations.length > 0) {
        data.recommendations.forEach(recommendation => {
            const recDiv = document.createElement('div');
            recDiv.className = 'alert alert-info mb-2';
            recDiv.innerHTML = `<i class="fas fa-info-circle me-2"></i>${recommendation}`;
            recommendationsList.appendChild(recDiv);
        });
    } else {
        recommendationsList.innerHTML = '<div class="text-muted">No specific recommendations at this time</div>';
    }
}

function updateMetricTrend(metricName, trendData) {
    if (!trendData) return;
    
    const statusElement = document.getElementById(`${metricName}Status`);
    const changeElement = document.getElementById(`${metricName}Change`);
    const avgElement = document.getElementById(`${metricName}Avg`);
    
    // Check if required elements exist before proceeding
    if (!statusElement || !changeElement || !avgElement) {
        console.warn(`Missing DOM elements for metric: ${metricName}`);
        return;
    }
    
    const trend = trendData.trend || 'stable';
    const trendColors = {
        'improving': 'bg-success',
        'degrading': 'bg-danger',
        'stable': 'bg-warning'
    };
    
    // Ensure trend is a string before calling string methods
    if (trend && typeof trend === 'string') {
        statusElement.textContent = trend.charAt(0).toUpperCase() + trend.slice(1);
        statusElement.className = `badge ${trendColors[trend] || 'bg-secondary'}`;
    } else {
        statusElement.textContent = 'Stable';
        statusElement.className = 'badge bg-warning';
    }
    
    const changePercent = trendData.change_percent || 0;
    changeElement.textContent = `${changePercent > 0 ? '+' : ''}${changePercent}%`;
    
    if (trendData.current_avg !== undefined) {
        let avgText = trendData.current_avg;
        if (metricName === 'latency') {
            avgText += 'ms';
        } else if (metricName === 'bandwidth') {
            avgText += ' Mbps';
        } else if (metricName === 'packetLoss') {
            avgText += '%';
        }
        avgElement.textContent = avgText;
    }
}

// Network Failure Prediction
document.getElementById('failurePredictionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const failurePredictionResults = document.getElementById('failurePredictionResults');
    const failurePredictionLoading = document.getElementById('failurePredictionLoading');
    const failurePredictionError = document.getElementById('failurePredictionError');
    
    // Hide previous results
    failurePredictionResults.style.display = 'none';
    failurePredictionError.style.display = 'none';
    failurePredictionLoading.style.display = 'block';
    
    const formData = {
        destination: document.getElementById('failureDestination').value,
        prediction_horizon: parseInt(document.getElementById('predictionHorizon').value),
        current_conditions: document.getElementById('currentConditions').value
    };
    
    fetch('/api/predict-failure', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        failurePredictionLoading.style.display = 'none';
        
        if (data.status === 'success') {
            displayFailurePredictionResults(data);
            failurePredictionResults.style.display = 'block';
        } else {
            document.getElementById('failureErrorMessage').textContent = data.error || 'Failure prediction unavailable';
            failurePredictionError.style.display = 'block';
        }
    })
    .catch(error => {
        failurePredictionLoading.style.display = 'none';
        document.getElementById('failureErrorMessage').textContent = 'Network error: ' + error.message;
        failurePredictionError.style.display = 'block';
    });
});

function displayFailurePredictionResults(data) {
    // Risk Level and Probability
    const riskLevel = document.getElementById('riskLevel');
    const failureProbability = document.getElementById('failureProbability');
    const timeHorizon = document.getElementById('timeHorizon');
    
    const riskColors = {
        'low': 'text-success',
        'moderate': 'text-warning',
        'high': 'text-danger',
        'critical': 'text-danger'
    };
    
    const riskLevelText = data.risk_level || 'moderate';
    riskLevel.className = `performance-indicator ${riskColors[riskLevelText] || 'text-warning'}`;
    riskLevel.textContent = riskLevelText.toUpperCase();
    
    const probabilityPercent = Math.round((data.failure_probability || 0.15) * 100);
    failureProbability.textContent = `${probabilityPercent}% probability`;
    timeHorizon.textContent = document.getElementById('predictionHorizon').value;
    
    // Confidence Score
    const confidencePercent = Math.round((data.confidence_score || 0.78) * 100);
    document.getElementById('failureConfidenceScore').textContent = `${confidencePercent}%`;
    document.getElementById('failureConfidenceBar').style.width = `${confidencePercent}%`;
    
    // Risk Factors
    const riskFactorsList = document.getElementById('riskFactorsList');
    riskFactorsList.innerHTML = '';
    
    if (data.risk_factors && data.risk_factors.length > 0) {
        data.risk_factors.forEach(factor => {
            const factorDiv = document.createElement('div');
            factorDiv.className = 'risk-factor mb-1';
            factorDiv.innerHTML = `<small><i class="fas fa-exclamation-circle text-warning me-2"></i>${factor}</small>`;
            riskFactorsList.appendChild(factorDiv);
        });
    } else {
        riskFactorsList.innerHTML = '<small class="text-muted">No specific risk factors identified</small>';
    }
    
    // Recommendations
    const recommendationsList = document.getElementById('recommendationsList');
    recommendationsList.innerHTML = '';
    
    if (data.recommendations && data.recommendations.length > 0) {
        data.recommendations.forEach(rec => {
            const recDiv = document.createElement('div');
            recDiv.className = 'recommendation mb-1';
            recDiv.innerHTML = `<small><i class="fas fa-shield-alt text-info me-2"></i>${rec}</small>`;
            recommendationsList.appendChild(recDiv);
        });
    } else {
        recommendationsList.innerHTML = '<small class="text-muted">No specific recommendations available</small>';
    }
}

// QoS Compliance Analysis
function analyzeQoSCompliance() {
    const destination = document.getElementById('qosDestination').value.trim();
    const testId = document.getElementById('qosTestId').value.trim();
    
    if (!destination && !testId) {
        alert('Please enter either a destination or test ID for analysis');
        return;
    }
    
    const qosResults = document.getElementById('qosResults');
    const qosLoading = document.getElementById('qosLoading');
    const qosError = document.getElementById('qosError');
    
    // Hide previous results
    qosResults.style.display = 'none';
    qosError.style.display = 'none';
    qosLoading.style.display = 'block';
    
    // Build query parameters
    const params = new URLSearchParams();
    if (destination) params.append('destination', destination);
    if (testId) params.append('test_id', testId);
    
    fetch(`/api/qos_compliance_analysis?${params}`)
    .then(response => response.json())
    .then(data => {
        qosLoading.style.display = 'none';
        
        if (data.status === 'success') {
            displayQoSResults(data);
            qosResults.style.display = 'block';
        } else {
            document.getElementById('qosErrorMessage').textContent = data.error || 'Analysis failed';
            qosError.style.display = 'block';
        }
    })
    .catch(error => {
        qosLoading.style.display = 'none';
        document.getElementById('qosErrorMessage').textContent = 'Network error: ' + error.message;
        qosError.style.display = 'block';
    });
}

function displayQoSResults(data) {
    // Overall compliance metrics
    document.getElementById('qosComplianceScore').textContent = data.overall_compliance_score.toFixed(2);
    document.getElementById('qosComplianceLevel').textContent = data.compliance_level;
    document.getElementById('qosConfidence').textContent = Math.round(data.confidence_score * 100) + '%';
    document.getElementById('qosSamples').textContent = data.total_samples;
    
    // Set compliance level color
    const levelElement = document.getElementById('qosComplianceLevel');
    if (data.compliance_level === 'Excellent' || data.compliance_level === 'Good') {
        levelElement.className = 'text-success';
    } else if (data.compliance_level === 'Fair') {
        levelElement.className = 'text-warning';
    } else {
        levelElement.className = 'text-danger';
    }
    
    // Compliance distribution
    const distribution = data.compliance_distribution;
    const total = distribution.fully_compliant + distribution.partially_compliant + distribution.non_compliant;
    
    if (total > 0) {
        const fullyPct = (distribution.fully_compliant / total) * 100;
        const partiallyPct = (distribution.partially_compliant / total) * 100;
        const nonPct = (distribution.non_compliant / total) * 100;
        
        document.getElementById('qosFullyCompliant').style.width = fullyPct + '%';
        document.getElementById('qosFullyCompliant').textContent = fullyPct > 10 ? Math.round(fullyPct) + '%' : '';
        
        document.getElementById('qosPartiallyCompliant').style.width = partiallyPct + '%';
        document.getElementById('qosPartiallyCompliant').textContent = partiallyPct > 10 ? Math.round(partiallyPct) + '%' : '';
        
        document.getElementById('qosNonCompliant').style.width = nonPct + '%';
        document.getElementById('qosNonCompliant').textContent = nonPct > 10 ? Math.round(nonPct) + '%' : '';
    }
    
    // DSCP Analysis
    const dscpAnalysis = document.getElementById('qosDscpAnalysis');
    dscpAnalysis.innerHTML = '';
    
    if (data.insights && data.insights.dscp_analysis) {
        Object.entries(data.insights.dscp_analysis).forEach(([dscp, info]) => {
            const dscpDiv = document.createElement('div');
            dscpDiv.className = 'mb-2 p-2 border rounded';
            
            const complianceColor = info.compliance_score >= 1.5 ? 'success' : 
                                  info.compliance_score >= 1.0 ? 'warning' : 'danger';
            
            dscpDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <strong>DSCP ${dscp}</strong>
                    <span class="badge bg-${complianceColor}">${info.compliance_score.toFixed(2)}</span>
                </div>
                <small class="text-muted">${info.description}</small><br>
                <small>Samples: ${info.count}</small>
            `;
            dscpAnalysis.appendChild(dscpDiv);
        });
    } else {
        dscpAnalysis.innerHTML = '<small class="text-muted">No DSCP analysis data available</small>';
    }
    
    // Traffic Violations
    const violationsDiv = document.getElementById('qosViolations');
    violationsDiv.innerHTML = '';
    
    if (data.insights) {
        // Latency violations
        if (data.insights.latency_violations && data.insights.latency_violations.length > 0) {
            data.insights.latency_violations.forEach(violation => {
                const violationDiv = document.createElement('div');
                violationDiv.className = 'mb-2 p-2 bg-warning bg-opacity-25 rounded';
                violationDiv.innerHTML = `
                    <strong>Latency Violation</strong><br>
                    <small>Average: ${violation.average_latency.toFixed(1)}ms</small><br>
                    <small>Affected samples: ${violation.affected_samples}</small>
                `;
                violationsDiv.appendChild(violationDiv);
            });
        }
        
        // Bandwidth issues
        if (data.insights.bandwidth_issues && data.insights.bandwidth_issues.length > 0) {
            data.insights.bandwidth_issues.forEach(issue => {
                const issueDiv = document.createElement('div');
                issueDiv.className = 'mb-2 p-2 bg-danger bg-opacity-25 rounded';
                issueDiv.innerHTML = `
                    <strong>Bandwidth Issue</strong><br>
                    <small>Average: ${issue.average_bandwidth.toFixed(1)} Mbps</small><br>
                    <small>Risk: ${issue.potential_congestion_risk}</small>
                `;
                violationsDiv.appendChild(issueDiv);
            });
        }
        
        if (violationsDiv.children.length === 0) {
            violationsDiv.innerHTML = '<small class="text-muted">No significant violations detected</small>';
        }
    }
    
    // Recommendations
    const recommendationsDiv = document.getElementById('qosRecommendations');
    recommendationsDiv.innerHTML = '';
    
    if (data.recommendations && data.recommendations.length > 0) {
        data.recommendations.forEach(rec => {
            const recDiv = document.createElement('div');
            recDiv.className = 'recommendation mb-2 p-2 bg-info bg-opacity-10 rounded';
            recDiv.innerHTML = `<small><i class="fas fa-lightbulb text-info me-2"></i>${rec}</small>`;
            recommendationsDiv.appendChild(recDiv);
        });
    } else {
        recommendationsDiv.innerHTML = '<small class="text-muted">No specific recommendations available</small>';
    }
}
</script>
{% endblock %}