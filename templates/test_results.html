{% extends "base.html" %}

{% block title %}Test Results - StreamSwarm{% endblock %}

{% block content %}
<div class="container">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <h1 class="h2 mb-3">
                <i class="fas fa-chart-line me-2"></i>
                Test Results: {{ test.name }}
            </h1>
            <div class="d-flex align-items-center gap-3">
                <span class="badge bg-{{ 'success' if test.status == 'completed' else 'warning' if test.status == 'running' else 'secondary' }} fs-6">
                    {{ test.status | title }}
                </span>
                <span class="text-muted">Destination: <code>{{ test.destination }}</code></span>
                <span class="text-muted">Duration: {{ test.duration // 60 }}m {{ test.duration % 60 }}s</span>
            </div>
        </div>
        <div class="col-auto">
            <div class="btn-group" role="group">
                {% if test.status in ['completed', 'failed'] %}
                    <a href="{{ url_for('diagnose_test', test_id=test.id) }}" class="btn btn-primary">
                        <i class="fas fa-stethoscope me-1"></i> Diagnose Results
                    </a>
                    <button class="btn btn-success" onclick="exportPDF({{ test.id }})">
                        <i class="fas fa-file-pdf me-1"></i> Export PDF Report
                    </button>
                {% endif %}
                <a href="{{ url_for('tests') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i>
                    Back to Tests
                </a>
            </div>
        </div>
    </div>

    <!-- Test Summary -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card">
                <div class="card-body text-center">
                    <h5 class="card-title">Participating Clients</h5>
                    <h2 class="text-info">{{ clients | length }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card">
                <div class="card-body text-center">
                    <h5 class="card-title">Data Points</h5>
                    <h2 class="text-success" id="data-points">{{ results | length }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card">
                <div class="card-body text-center">
                    <h5 class="card-title">Avg Latency</h5>
                    <h2 class="text-warning" id="avg-latency">--</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card">
                <div class="card-body text-center">
                    <h5 class="card-title">Packet Loss</h5>
                    <h2 class="text-danger" id="avg-packet-loss">--</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0" id="chart-title">
                            <i class="fas fa-chart-line me-2"></i>
                            Network Latency Over Time
                        </h5>
                        <div class="dropdown">
                            <button class="btn btn-outline-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <span id="current-metric-label">Network Latency</span>
                            </button>
                            <ul class="dropdown-menu">
                                <li><h6 class="dropdown-header">Network Performance</h6></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('ping_latency')">Network Latency</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('ping_packet_loss')">Packet Loss</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('jitter')">Network Jitter</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('dns_resolution_time')">DNS Resolution Time</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('tcp_connect_time')">TCP Connect Time</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('ssl_handshake_time')">SSL Handshake Time</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('ttfb')">Time to First Byte</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><h6 class="dropdown-header">System Performance</h6></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('cpu_load_1min')">CPU Load (1min)</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('cpu_load_5min')">CPU Load (5min)</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('cpu_load_15min')">CPU Load (15min)</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('cpu_freq_current')">CPU Frequency</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('cpu_cores')">CPU Cores</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('cpu_temperature')">CPU Temperature</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('process_count')">Process Count</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('tcp_connections')">TCP Connections</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><h6 class="dropdown-header">Network Interface</h6></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('network_bytes_sent')">Bytes Sent</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('network_bytes_recv')">Bytes Received</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('network_packets_sent')">Packets Sent</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('network_packets_recv')">Packets Received</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('network_errors_in')">Network Errors In</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('network_errors_out')">Network Errors Out</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('network_drops_in')">Network Drops In</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('network_drops_out')">Network Drops Out</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><h6 class="dropdown-header">Storage Performance</h6></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('disk_read_iops')">Disk Read IOPS</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('disk_write_iops')">Disk Write IOPS</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('disk_read_bytes_sec')">Disk Read Throughput</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('disk_write_bytes_sec')">Disk Write Throughput</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><h6 class="dropdown-header">Bandwidth Performance</h6></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('bandwidth_upload')">Upload Speed (Mbps)</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('bandwidth_download')">Download Speed (Mbps)</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><h6 class="dropdown-header">Quality of Service</h6></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('dscp_value')">DSCP Values</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('cos_value')">CoS Values</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('qos_policy_compliant')">QoS Policy Compliance</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><h6 class="dropdown-header">Memory Details</h6></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('memory_available')">Memory Available</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('memory_cached')">Memory Cached</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('memory_buffers')">Memory Buffers</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('swap_percent')">Swap Usage</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><h6 class="dropdown-header">Advanced Network</h6></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('traceroute_hops')">Traceroute Hops</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="alert alert-info alert-dismissible fade show" role="alert">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Pro Tip:</strong> Click on any data point in the chart to see detailed metrics and network path information for troubleshooting.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    <div style="position: relative; height: 400px;">
                        <canvas id="networkChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-lg-4 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-microchip me-2"></i>
                        CPU Usage
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="cpuChart" height="300"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-memory me-2"></i>
                        Memory Usage
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="memoryChart" height="300"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-hdd me-2"></i>
                        Disk Usage
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="diskChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Client Details -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-desktop me-2"></i>
                        Client Performance Summary
                    </h5>
                </div>
                <div class="card-body">
                    {% if clients %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Client</th>
                                    <th>Data Points</th>
                                    <th>Avg Latency</th>
                                    <th>Avg Packet Loss</th>
                                    <th>Avg CPU</th>
                                    <th>Avg Memory</th>
                                    <th>Avg Disk</th>
                                </tr>
                            </thead>
                            <tbody id="clientSummaryTable">
                                {% for client in clients %}
                                <tr>
                                    <td><strong>{{ client.hostname }}</strong></td>
                                    <td class="client-data-points" data-client="{{ client.id }}">--</td>
                                    <td class="client-avg-latency" data-client="{{ client.id }}">--</td>
                                    <td class="client-avg-packet-loss" data-client="{{ client.id }}">--</td>
                                    <td class="client-avg-cpu" data-client="{{ client.id }}">--</td>
                                    <td class="client-avg-memory" data-client="{{ client.id }}">--</td>
                                    <td class="client-avg-disk" data-client="{{ client.id }}">--</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted mb-0">No client data available for this test.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Detailed Process Monitoring -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-tasks me-2"></i>
                        Process Monitoring Details
                    </h5>
                </div>
                <div class="card-body">
                    {% set process_result = results|selectattr('top_processes_cpu')|first %}
                    {% if process_result %}
                        {% set cpu_processes = process_result.top_processes_cpu | tojsonfilter %}
                        {% set mem_processes = process_result.top_processes_memory | tojsonfilter %}
                        
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary mb-3">
                                    <i class="fas fa-microchip me-2"></i>Top Processes by CPU Usage
                                </h6>
                                {% for process in cpu_processes[:5] %}
                                    <div class="card mb-2">
                                        <div class="card-body py-2">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <strong>{{ process.name }}</strong>
                                                    <small class="text-muted d-block">PID: {{ process.pid }}</small>
                                                </div>
                                                <div class="text-end">
                                                    <span class="badge bg-primary">{{ "%.1f"|format(process.cpu_percent) }}% CPU</span>
                                                    <span class="badge bg-secondary">{{ "%.1f"|format(process.memory_percent) }}% RAM</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            
                            <div class="col-md-6">
                                <h6 class="text-success mb-3">
                                    <i class="fas fa-memory me-2"></i>Top Processes by Memory Usage
                                </h6>
                                {% for process in mem_processes[:5] %}
                                    <div class="card mb-2">
                                        <div class="card-body py-2">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <strong>{{ process.name }}</strong>
                                                    <small class="text-muted d-block">PID: {{ process.pid }}</small>
                                                </div>
                                                <div class="text-end">
                                                    <span class="badge bg-success">{{ "%.1f"|format(process.memory_percent) }}% RAM</span>
                                                    <span class="badge bg-secondary">{{ "%.1f"|format(process.cpu_percent) }}% CPU</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            No detailed process monitoring data available for this test.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Network Interface Details -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-network-wired me-2"></i>
                        Network Interface Details by Client
                    </h5>
                </div>
                <div class="card-body">
                    {% set interface_clients = results|selectattr('network_interface_info')|groupby('client_id')|list %}
                    {% if interface_clients %}
                        {% for client_id, client_results in interface_clients %}
                            {% set client = clients|selectattr('id', 'equalto', client_id)|first %}
                            {% set interface_data = client_results[0].network_interface_info | tojsonfilter %}
                            {% if interface_data and interface_data.primary_interface %}
                                <div class="card mb-3 bg-dark border-secondary">
                                    <div class="card-header bg-secondary text-white">
                                        <h6 class="mb-0">
                                            <i class="fas fa-desktop me-2"></i>
                                            {{ client.hostname if client else 'Unknown Client' }}
                                            <small class="text-light opacity-75">({{ client.ip_address if client else 'Unknown IP' }})</small>
                                        </h6>
                                    </div>
                                    <div class="card-body bg-dark text-white">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h6 class="text-info mb-3">Primary Interface</h6>
                                                <div class="mb-2">
                                                    <strong>Interface:</strong> 
                                                    <span class="badge bg-secondary">{{ interface_data.primary_interface }}</span>
                                                </div>
                                                <div class="mb-2">
                                                    <strong>Type:</strong>
                                                    {% if interface_data.is_wireless %}
                                                        <span class="badge bg-info">
                                                            <i class="fas fa-wifi me-1"></i>Wireless (Primary)
                                                        </span>
                                                    {% elif interface_data.has_secondary_wireless and interface_data.interface_type == 'ethernet' %}
                                                        <span class="badge bg-success me-1">
                                                            <i class="fas fa-ethernet me-1"></i>Ethernet (Primary)
                                                        </span>
                                                        <span class="badge bg-info">
                                                            <i class="fas fa-wifi me-1"></i>Wireless (Secondary)
                                                        </span>
                                                    {% elif interface_data.interface_type == 'ethernet' %}
                                                        <span class="badge bg-success">
                                                            <i class="fas fa-ethernet me-1"></i>Ethernet
                                                        </span>
                                                    {% elif interface_data.interface_type == 'vpn' %}
                                                        <span class="badge bg-warning">
                                                            <i class="fas fa-shield-alt me-1"></i>VPN
                                                        </span>
                                                    {% else %}
                                                        <span class="badge bg-secondary">{{ interface_data.interface_type|title }}</span>
                                                    {% endif %}
                                                </div>
                                                {% if interface_data.connection_speed %}
                                                    <div class="mb-2">
                                                        <strong>Speed:</strong> {{ interface_data.connection_speed }} Mbps
                                                    </div>
                                                {% endif %}
                                                {% if interface_data.duplex_mode and interface_data.duplex_mode != 'unknown' %}
                                                    <div class="mb-2">
                                                        <strong>Duplex:</strong> {{ interface_data.duplex_mode|title }}
                                                    </div>
                                                {% endif %}
                                            </div>
                                            
                                            {% if interface_data.is_wireless or interface_data.has_secondary_wireless %}
                                                <div class="col-md-6">
                                                    <h6 class="text-info mb-3">
                                                        {% if interface_data.is_wireless %}
                                                            Wireless Details (Primary Interface)
                                                        {% else %}
                                                            Wireless Details (Secondary Interface: {{ interface_data.wireless_interface_name }})
                                                        {% endif %}
                                                    </h6>
                                                    {% if interface_data.wireless_info and (interface_data.wireless_info.ssid or interface_data.wireless_info.signal_strength or interface_data.wireless_info.frequency) %}
                                                        {% if interface_data.wireless_info.ssid %}
                                                            <div class="mb-2">
                                                                <strong>Network (SSID):</strong> {{ interface_data.wireless_info.ssid }}
                                                            </div>
                                                        {% endif %}
                                                        {% if interface_data.wireless_info.signal_strength %}
                                                            <div class="mb-2">
                                                                <strong>Signal Strength:</strong> {{ interface_data.wireless_info.signal_strength }}
                                                            </div>
                                                        {% endif %}
                                                        {% if interface_data.wireless_info.frequency %}
                                                            <div class="mb-2">
                                                                <strong>Frequency:</strong> {{ interface_data.wireless_info.frequency }}
                                                            </div>
                                                        {% endif %}
                                                        {% if interface_data.wireless_info.channel %}
                                                            <div class="mb-2">
                                                                <strong>Channel:</strong> {{ interface_data.wireless_info.channel }}
                                                            </div>
                                                        {% endif %}
                                                        {% if interface_data.wireless_info.mac_address %}
                                                            <div class="mb-2">
                                                                <strong>MAC Address:</strong> {{ interface_data.wireless_info.mac_address }}
                                                            </div>
                                                        {% endif %}
                                                        {% if interface_data.wireless_info.txpower %}
                                                            <div class="mb-2">
                                                                <strong>TX Power:</strong> {{ interface_data.wireless_info.txpower }}
                                                            </div>
                                                        {% endif %}
                                                        {% if interface_data.wireless_info.security %}
                                                            <div class="mb-2">
                                                                <strong>Security:</strong> {{ interface_data.wireless_info.security }}
                                                            </div>
                                                        {% endif %}
                                                        
                                                        <!-- Signal strength monitoring statistics for this client -->
                                                        {% set client_signal_result = client_results|selectattr('signal_strength_min')|selectattr('signal_strength_max')|selectattr('signal_strength_avg')|selectattr('signal_strength_samples')|selectattr('signal_strength_samples', 'greaterthan', 0)|sort(attribute='signal_strength_samples', reverse=true)|first %}
                                                        {% if client_signal_result %}
                                                            <hr class="border-secondary my-3">
                                                            <h6 class="text-info mb-2">
                                                                <i class="fas fa-signal me-2"></i>
                                                                Signal Strength During Test
                                                            </h6>
                                                            <div class="row text-center">
                                                                <div class="col-4">
                                                                    <div class="bg-danger bg-opacity-25 border border-danger rounded p-2">
                                                                        <small class="text-danger">Min</small><br>
                                                                        <strong class="text-white">{{ "%.1f"|format(client_signal_result.signal_strength_min) }} dBm</strong>
                                                                    </div>
                                                                </div>
                                                                <div class="col-4">
                                                                    <div class="bg-warning bg-opacity-25 border border-warning rounded p-2">
                                                                        <small class="text-warning">Avg</small><br>
                                                                        <strong class="text-white">{{ "%.1f"|format(client_signal_result.signal_strength_avg) }} dBm</strong>
                                                                    </div>
                                                                </div>
                                                                <div class="col-4">
                                                                    <div class="bg-success bg-opacity-25 border border-success rounded p-2">
                                                                        <small class="text-success">Max</small><br>
                                                                        <strong class="text-white">{{ "%.1f"|format(client_signal_result.signal_strength_max) }} dBm</strong>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <small class="text-muted mt-2 d-block">
                                                                Based on {{ client_signal_result.signal_strength_samples }} measurements throughout test duration
                                                            </small>
                                                            
                                                            <!-- Signal strength interpretation -->
                                                            {% if client_signal_result.signal_strength_avg >= -30 %}
                                                                <div class="alert alert-success mt-2 py-2">
                                                                    <small><i class="fas fa-check-circle me-1"></i> Excellent signal strength</small>
                                                                </div>
                                                            {% elif client_signal_result.signal_strength_avg >= -50 %}
                                                                <div class="alert alert-info mt-2 py-2">
                                                                    <small><i class="fas fa-info-circle me-1"></i> Good signal strength</small>
                                                                </div>
                                                            {% elif client_signal_result.signal_strength_avg >= -70 %}
                                                                <div class="alert alert-warning mt-2 py-2">
                                                                    <small><i class="fas fa-exclamation-triangle me-1"></i> Fair signal strength</small>
                                                                </div>
                                                            {% else %}
                                                                <div class="alert alert-danger mt-2 py-2">
                                                                    <small><i class="fas fa-times-circle me-1"></i> Poor signal strength</small>
                                                                </div>
                                                            {% endif %}
                                                        {% endif %}
                                                    {% else %}
                                                        <div class="alert alert-info">
                                                            <i class="fas fa-info-circle me-2"></i>
                                                            Wireless interface detected but detailed information requires the 'iw' package (install with: sudo apt install iw) that may not be available in this environment.
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            {% elif not interface_data.is_wireless %}
                                                <div class="col-md-6">
                                                    <h6 class="text-success mb-3">Connection Details</h6>
                                                    <div class="alert alert-success">
                                                        <i class="fas fa-check-circle me-2"></i>
                                                        Wired connection provides stable, low-latency networking
                                                    </div>
                                                </div>
                                            {% else %}
                                                <div class="col-md-6">
                                                    <h6 class="text-warning mb-3">Wireless Details</h6>
                                                    <div class="alert alert-warning">
                                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                                        Wireless interface detected but detailed information not available
                                                    </div>
                                                </div>
                                            {% endif %}
                                        </div>
                                        
                                        {% if interface_data.all_interfaces|length > 1 %}
                                            <hr class="border-secondary">
                                            <h6 class="text-light mb-3">All Network Interfaces</h6>
                                            <div class="row">
                                                {% for interface in interface_data.all_interfaces %}
                                                    <div class="col-md-6 mb-2">
                                                        <div class="bg-secondary border border-secondary rounded p-2">
                                                            <div class="d-flex justify-content-between align-items-center text-white">
                                                                <div>
                                                                    <strong>{{ interface.name }}</strong>
                                                                    {% if interface.is_up %}
                                                                        <span class="badge bg-success ms-1">UP</span>
                                                                    {% else %}
                                                                        <span class="badge bg-danger ms-1">DOWN</span>
                                                                    {% endif %}
                                                                </div>
                                                                {% if interface.speed %}
                                                                    <small class="text-light opacity-75">{{ interface.speed }} Mbps</small>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            No network interface data available for this test.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Comprehensive Metrics Analysis -->
    {% if results and results|length > 0 %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-bar me-2"></i>
                        Comprehensive Metrics Analysis (65+ Metrics)
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <h6>Network Performance</h6>
                                    {% set avg_latency = results | extract_numeric('ping_latency') %}
                                    <p class="mb-1">Latency: {{ "%.1f"|format(avg_latency | average) if avg_latency else 'N/A' }}ms</p>
                                    {% set avg_bandwidth = results | extract_numeric('bandwidth_download') %}
                                    <p class="mb-0">Bandwidth: {{ "%.1f"|format(avg_bandwidth | average) if avg_bandwidth else 'N/A' }} Mbps</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h6>System Resources</h6>
                                    {% set avg_cpu = results | extract_numeric('cpu_percent') %}
                                    <p class="mb-1">CPU: {{ "%.1f"|format(avg_cpu | average) if avg_cpu else 'N/A' }}%</p>
                                    {% set avg_memory = results | extract_numeric('memory_percent') %}
                                    <p class="mb-0">Memory: {{ "%.1f"|format(avg_memory | average) if avg_memory else 'N/A' }}%</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card bg-warning text-dark">
                                <div class="card-body text-center">
                                    <h6>Quality of Service</h6>
                                    {% set dscp_vals = results | extract_numeric('dscp_value') %}
                                    <p class="mb-1">DSCP: {{ dscp_vals | first if dscp_vals else 'N/A' }}</p>
                                    {% set ecn_capable = results | selectattr('ecn_capable', 'equalto', true) | list %}
                                    <p class="mb-0">ECN: {{ 'Yes' if ecn_capable else 'No' }}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h6>Infrastructure</h6>
                                    {% set power_vals = results | extract_numeric('power_consumption_watts') %}
                                    <p class="mb-1">Power: {{ "%.1f"|format(power_vals | average) if power_vals else 'N/A' }}W</p>
                                    {% set smart_health = results | selectattr('smart_drive_health') | list %}
                                    <p class="mb-0">Drives: {{ 'Healthy' if smart_health else 'N/A' }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Detailed Metrics Tables -->
                    <div class="row">
                        <div class="col-12">
                            <div class="accordion" id="metricsAccordion">
                                <!-- Network Metrics -->
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#networkMetrics">
                                            <i class="fas fa-network-wired me-2"></i>Network Performance Metrics
                                        </button>
                                    </h2>
                                    <div id="networkMetrics" class="accordion-collapse collapse show" data-bs-parent="#metricsAccordion">
                                        <div class="accordion-body">
                                            <div class="table-responsive">
                                                <table class="table table-sm">
                                                    <thead>
                                                        <tr><th>Metric</th><th>Average</th><th>Status</th></tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr>
                                                            <td>Ping Latency (ms)</td>
                                                            {% set avg_latency = results | extract_numeric('ping_latency') %}
                                                            <td>{{ "%.2f"|format(avg_latency | average) if avg_latency else 'N/A' }}</td>
                                                            <td>
                                                                {% if avg_latency and (avg_latency | average) < 50 %}
                                                                    <span class="badge bg-success">Excellent</span>
                                                                {% elif avg_latency and (avg_latency | average) < 100 %}
                                                                    <span class="badge bg-warning">Good</span>
                                                                {% elif avg_latency %}
                                                                    <span class="badge bg-danger">Poor</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary">No Data</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>DNS Resolution (ms)</td>
                                                            {% set avg_dns = results | extract_numeric('dns_resolution_time') %}
                                                            <td>{{ "%.2f"|format(avg_dns | average) if avg_dns else 'N/A' }}</td>
                                                            <td>
                                                                {% if avg_dns and (avg_dns | average) < 50 %}
                                                                    <span class="badge bg-success">Excellent</span>
                                                                {% elif avg_dns %}
                                                                    <span class="badge bg-warning">Good</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary">N/A</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>Bandwidth Download (Mbps)</td>
                                                            {% set avg_down = results | extract_numeric('bandwidth_download') %}
                                                            <td>{{ "%.2f"|format(avg_down | average) if avg_down else 'N/A' }}</td>
                                                            <td>
                                                                {% if avg_down and (avg_down | average) > 50 %}
                                                                    <span class="badge bg-success">Excellent</span>
                                                                {% elif avg_down and (avg_down | average) > 10 %}
                                                                    <span class="badge bg-warning">Good</span>
                                                                {% elif avg_down %}
                                                                    <span class="badge bg-danger">Poor</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary">N/A</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>MTU Size</td>
                                                            {% set mtu_values = [] %}
                                                            {% for result in results %}
                                                                {% if result.network_interface_info %}
                                                                    {% set interface_data = result.network_interface_info | from_json %}
                                                                    {% if interface_data.get('all_interfaces') %}
                                                                        {% for interface in interface_data.all_interfaces %}
                                                                            {% if interface.get('mtu') and interface.get('is_up') %}
                                                                                {% set _ = mtu_values.append(interface.mtu) %}
                                                                            {% endif %}
                                                                        {% endfor %}
                                                                    {% endif %}
                                                                {% endif %}
                                                            {% endfor %}
                                                            {% if mtu_values %}
                                                                {% set avg_mtu = (mtu_values | sum / mtu_values | length) | round(0) | int %}
                                                                <td>{{ avg_mtu }} bytes</td>
                                                                <td>
                                                                    {% if avg_mtu == 1500 %}
                                                                        <span class="badge bg-success">Standard</span>
                                                                    {% elif avg_mtu > 1500 %}
                                                                        <span class="badge bg-info">Jumbo</span>
                                                                    {% else %}
                                                                        <span class="badge bg-warning">Small</span>
                                                                    {% endif %}
                                                                </td>
                                                            {% else %}
                                                                <td>N/A</td>
                                                                <td><span class="badge bg-secondary">N/A</span></td>
                                                            {% endif %}
                                                        </tr>
                                                        <tr>
                                                            <td>TCP Retransmission Rate (%)</td>
                                                            {% set avg_retrans = results | extract_numeric('tcp_retransmission_rate') %}
                                                            <td>{{ "%.3f"|format(avg_retrans | average) if avg_retrans else 'N/A' }}</td>
                                                            <td>
                                                                {% if avg_retrans and (avg_retrans | average) < 1 %}
                                                                    <span class="badge bg-success">Good</span>
                                                                {% elif avg_retrans %}
                                                                    <span class="badge bg-warning">Monitor</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary">N/A</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>Network Packets Sent</td>
                                                            {% set avg_packets_sent = results | extract_numeric('network_packets_sent') %}
                                                            <td>{{ "{:,}".format(avg_packets_sent | average | round(0) | int) if avg_packets_sent else 'N/A' }}</td>
                                                            <td><span class="badge bg-info">Info</span></td>
                                                        </tr>
                                                        <tr>
                                                            <td>Network Packets Received</td>
                                                            {% set avg_packets_recv = results | extract_numeric('network_packets_recv') %}
                                                            <td>{{ "{:,}".format(avg_packets_recv | average | round(0) | int) if avg_packets_recv else 'N/A' }}</td>
                                                            <td><span class="badge bg-info">Info</span></td>
                                                        </tr>

                                                        <tr>
                                                            <td>
                                                                Network Errors In
                                                                <i class="fas fa-question-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" 
                                                                   title="Hardware/driver-level errors while receiving packets (checksum failures, malformed packets, interface issues). Zero errors indicates healthy network hardware."></i>
                                                            </td>
                                                            {% set avg_errors_in = results | extract_numeric('network_errors_in') %}
                                                            <td>{{ "{:,}".format(avg_errors_in | average | round(0) | int) if avg_errors_in else 'N/A' }}</td>
                                                            <td>
                                                                {% if avg_errors_in and (avg_errors_in | average) == 0 %}
                                                                    <span class="badge bg-success">Good</span>
                                                                {% elif avg_errors_in and (avg_errors_in | average) < 10 %}
                                                                    <span class="badge bg-warning">Monitor</span>
                                                                {% elif avg_errors_in %}
                                                                    <span class="badge bg-danger">High</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary">N/A</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>
                                                                Network Errors Out
                                                                <i class="fas fa-question-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" 
                                                                   title="Hardware/driver-level errors while sending packets. Zero errors indicates healthy network hardware and proper packet transmission."></i>
                                                            </td>
                                                            {% set avg_errors_out = results | extract_numeric('network_errors_out') %}
                                                            <td>{{ "{:,}".format(avg_errors_out | average | round(0) | int) if avg_errors_out else 'N/A' }}</td>
                                                            <td>
                                                                {% if avg_errors_out and (avg_errors_out | average) == 0 %}
                                                                    <span class="badge bg-success">Good</span>
                                                                {% elif avg_errors_out and (avg_errors_out | average) < 10 %}
                                                                    <span class="badge bg-warning">Monitor</span>
                                                                {% elif avg_errors_out %}
                                                                    <span class="badge bg-danger">High</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary">N/A</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>
                                                                Network Drops In
                                                                <i class="fas fa-question-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" 
                                                                   title="Incoming packets dropped due to buffer overflows, network congestion, firewalls, or traffic shaping. Normal during high traffic or with security filtering."></i>
                                                            </td>
                                                            {% set avg_drops_in = results | extract_numeric('network_drops_in') %}
                                                            <td>{{ "{:,}".format(avg_drops_in | average | round(0) | int) if avg_drops_in else 'N/A' }}</td>
                                                            <td>
                                                                {% if avg_drops_in and (avg_drops_in | average) == 0 %}
                                                                    <span class="badge bg-success">Good</span>
                                                                {% elif avg_drops_in and (avg_drops_in | average) < 5000 %}
                                                                    <span class="badge bg-info">Normal</span>
                                                                {% elif avg_drops_in and (avg_drops_in | average) < 20000 %}
                                                                    <span class="badge bg-warning">Monitor</span>
                                                                {% elif avg_drops_in %}
                                                                    <span class="badge bg-danger">High</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary">N/A</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>
                                                                Network Drops Out
                                                                <i class="fas fa-question-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" 
                                                                   title="Outgoing packets dropped due to buffer overflows or traffic shaping. Often zero on most systems (always 0 on macOS/BSD)."></i>
                                                            </td>
                                                            {% set avg_drops_out = results | extract_numeric('network_drops_out') %}
                                                            <td>{{ "{:,}".format(avg_drops_out | average | round(0) | int) if avg_drops_out else 'N/A' }}</td>
                                                            <td>
                                                                {% if avg_drops_out and (avg_drops_out | average) == 0 %}
                                                                    <span class="badge bg-success">Good</span>
                                                                {% elif avg_drops_out and (avg_drops_out | average) < 5 %}
                                                                    <span class="badge bg-warning">Monitor</span>
                                                                {% elif avg_drops_out %}
                                                                    <span class="badge bg-danger">High</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary">N/A</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                                
                                                <!-- Network Metrics Explanation -->
                                                <div class="alert alert-info mt-3">
                                                    <h6><i class="fas fa-info-circle me-2"></i>Understanding Network Metrics</h6>
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <strong>Network Errors:</strong>
                                                            <ul class="mb-2">
                                                                <li>Hardware/driver-level issues</li>
                                                                <li>Corrupted or malformed packets</li>
                                                                <li>Interface hardware problems</li>
                                                                <li>Zero errors = healthy hardware</li>
                                                            </ul>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <strong>Network Drops:</strong>
                                                            <ul class="mb-2">
                                                                <li>Buffer overflows during traffic spikes</li>
                                                                <li>Firewall/security filtering</li>
                                                                <li>Network congestion management</li>
                                                                <li>QoS/traffic shaping policies</li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                    <small class="text-muted">
                                                        <strong>Common Pattern:</strong> High drops with zero errors typically indicates normal network traffic management rather than hardware issues.
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- TCP Window Analysis -->
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#tcpWindowAnalysis">
                                            <i class="fas fa-project-diagram me-2"></i>TCP Window Analysis (Bottleneck Attribution)
                                        </button>
                                    </h2>
                                    <div id="tcpWindowAnalysis" class="accordion-collapse collapse" data-bs-parent="#metricsAccordion">
                                        <div class="accordion-body">
                                            {% set tcp_results = results | selectattr('tcp_window_efficiency') | list %}
                                            {% if tcp_results %}
                                                <!-- TCP Window Efficiency Score -->
                                                <div class="row mb-4">
                                                    <div class="col-md-6">
                                                        <div class="card bg-primary text-white">
                                                            <div class="card-body text-center">
                                                                {% set avg_efficiency = tcp_results | extract_numeric('tcp_window_efficiency') %}
                                                                <h4 class="mb-2">{{ "%.1f"|format(avg_efficiency | average) if avg_efficiency else 'N/A' }}%</h4>
                                                                <p class="mb-0">TCP Window Efficiency</p>
                                                                {% if avg_efficiency %}
                                                                    {% set eff_score = avg_efficiency | average %}
                                                                    {% if eff_score >= 90 %}
                                                                        <small class="text-light">Excellent Performance</small>
                                                                    {% elif eff_score >= 70 %}
                                                                        <small class="text-light">Good Performance</small>
                                                                    {% elif eff_score >= 50 %}
                                                                        <small class="text-light">Fair Performance</small>
                                                                    {% else %}
                                                                        <small class="text-light">Poor Performance</small>
                                                                    {% endif %}
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="card bg-info text-white">
                                                            <div class="card-body text-center">
                                                                <h4 class="mb-2">
                                                                    {% set first_bottleneck = None %}
                                                                    {% for result in tcp_results %}
                                                                        {% if result.tcp_bottleneck_type and not first_bottleneck %}
                                                                            {% set first_bottleneck = result.tcp_bottleneck_type %}
                                                                        {% endif %}
                                                                    {% endfor %}
                                                                    {% if first_bottleneck %}
                                                                        {{ first_bottleneck.replace('_', ' ').title() }}
                                                                    {% else %}
                                                                        N/A
                                                                    {% endif %}
                                                                </h4>
                                                                <p class="mb-0">Primary Bottleneck</p>
                                                                <small class="text-light">Based on window analysis</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Detailed TCP Window Metrics -->
                                                <div class="table-responsive">
                                                    <table class="table table-sm">
                                                        <thead>
                                                            <tr><th>Metric</th><th>Average</th><th>Min</th><th>Max</th><th>Status</th></tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr>
                                                                <td>
                                                                    Round Trip Time (ms)
                                                                    <i class="fas fa-question-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" 
                                                                       title="Network latency measured during TCP connection. Lower is better."></i>
                                                                </td>
                                                                {% set avg_rtt = tcp_results | extract_numeric('tcp_rtt_avg') %}
                                                                {% set min_rtt = tcp_results | extract_numeric('tcp_rtt_min') %}
                                                                {% set max_rtt = tcp_results | extract_numeric('tcp_rtt_max') %}
                                                                <td>{{ "%.2f"|format((avg_rtt | average) * 1000) if avg_rtt else 'N/A' }}</td>
                                                                <td>{{ "%.2f"|format((min_rtt | min) * 1000) if min_rtt else 'N/A' }}</td>
                                                                <td>{{ "%.2f"|format((max_rtt | max) * 1000) if max_rtt else 'N/A' }}</td>
                                                                <td>
                                                                    {% if avg_rtt and ((avg_rtt | average) * 1000) < 50 %}
                                                                        <span class="badge bg-success">Excellent</span>
                                                                    {% elif avg_rtt and ((avg_rtt | average) * 1000) < 100 %}
                                                                        <span class="badge bg-warning">Good</span>
                                                                    {% elif avg_rtt %}
                                                                        <span class="badge bg-danger">Poor</span>
                                                                    {% else %}
                                                                        <span class="badge bg-secondary">N/A</span>
                                                                    {% endif %}
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <td>
                                                                    RTT Variation (ms)
                                                                    <i class="fas fa-question-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" 
                                                                       title="Network instability indicator. High variation suggests network congestion or path changes."></i>
                                                                </td>
                                                                {% set rtt_var = tcp_results | extract_numeric('tcp_rtt_variation') %}
                                                                <td>{{ "%.2f"|format((rtt_var | average) * 1000) if rtt_var else 'N/A' }}</td>
                                                                <td>-</td>
                                                                <td>{{ "%.2f"|format((rtt_var | max) * 1000) if rtt_var else 'N/A' }}</td>
                                                                <td>
                                                                    {% if rtt_var and ((rtt_var | average) * 1000) < 20 %}
                                                                        <span class="badge bg-success">Stable</span>
                                                                    {% elif rtt_var and ((rtt_var | average) * 1000) < 50 %}
                                                                        <span class="badge bg-warning">Moderate</span>
                                                                    {% elif rtt_var %}
                                                                        <span class="badge bg-danger">Unstable</span>
                                                                    {% else %}
                                                                        <span class="badge bg-secondary">N/A</span>
                                                                    {% endif %}
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <td>
                                                                    Congestion Window (KB)
                                                                    <i class="fas fa-question-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" 
                                                                       title="Amount of data TCP can send before receiving acknowledgment. Larger windows = better throughput."></i>
                                                                </td>
                                                                {% set avg_cwnd = tcp_results | extract_numeric('tcp_cwnd_avg') %}
                                                                {% set min_cwnd = tcp_results | extract_numeric('tcp_cwnd_min') %}
                                                                {% set max_cwnd = tcp_results | extract_numeric('tcp_cwnd_max') %}
                                                                <td>{{ "%.1f"|format((avg_cwnd | average) / 1024) if avg_cwnd else 'N/A' }}</td>
                                                                <td>{{ "%.1f"|format((min_cwnd | min) / 1024) if min_cwnd else 'N/A' }}</td>
                                                                <td>{{ "%.1f"|format((max_cwnd | max) / 1024) if max_cwnd else 'N/A' }}</td>
                                                                <td>
                                                                    {% if avg_cwnd and (avg_cwnd | average) > 65536 %}
                                                                        <span class="badge bg-success">Large</span>
                                                                    {% elif avg_cwnd and (avg_cwnd | average) > 32768 %}
                                                                        <span class="badge bg-warning">Medium</span>
                                                                    {% elif avg_cwnd %}
                                                                        <span class="badge bg-danger">Small</span>
                                                                    {% else %}
                                                                        <span class="badge bg-secondary">N/A</span>
                                                                    {% endif %}
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <td>
                                                                    Congestion Events
                                                                    <i class="fas fa-question-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" 
                                                                       title="Number of times TCP detected network congestion and reduced sending rate."></i>
                                                                </td>
                                                                {% set cong_events = tcp_results | extract_numeric('tcp_congestion_events') %}
                                                                <td>{{ cong_events | average | round(1) if cong_events else 'N/A' }}</td>
                                                                <td>{{ cong_events | min if cong_events else 'N/A' }}</td>
                                                                <td>{{ cong_events | max if cong_events else 'N/A' }}</td>
                                                                <td>
                                                                    {% if cong_events and (cong_events | average) == 0 %}
                                                                        <span class="badge bg-success">None</span>
                                                                    {% elif cong_events and (cong_events | average) < 3 %}
                                                                        <span class="badge bg-warning">Few</span>
                                                                    {% elif cong_events %}
                                                                        <span class="badge bg-danger">Many</span>
                                                                    {% else %}
                                                                        <span class="badge bg-secondary">N/A</span>
                                                                    {% endif %}
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <td>
                                                                    Retransmissions
                                                                    <i class="fas fa-question-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" 
                                                                       title="Packets that had to be resent due to loss or corruption."></i>
                                                                </td>
                                                                {% set retrans = tcp_results | extract_numeric('tcp_retransmissions') %}
                                                                <td>{{ retrans | average | round(1) if retrans else 'N/A' }}</td>
                                                                <td>{{ retrans | min if retrans else 'N/A' }}</td>
                                                                <td>{{ retrans | max if retrans else 'N/A' }}</td>
                                                                <td>
                                                                    {% if retrans and (retrans | average) == 0 %}
                                                                        <span class="badge bg-success">None</span>
                                                                    {% elif retrans and (retrans | average) < 5 %}
                                                                        <span class="badge bg-warning">Few</span>
                                                                    {% elif retrans %}
                                                                        <span class="badge bg-danger">Many</span>
                                                                    {% else %}
                                                                        <span class="badge bg-secondary">N/A</span>
                                                                    {% endif %}
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                                
                                                <!-- Bottleneck Attribution Analysis -->
                                                <div class="alert alert-info mt-3">
                                                    <h6><i class="fas fa-search me-2"></i>Bottleneck Attribution Analysis</h6>
                                                    {% if bottleneck_types %}
                                                        {% set bottleneck_counts = {} %}
                                                        {% for type in bottleneck_types %}
                                                            {% set _ = bottleneck_counts.update({type: bottleneck_counts.get(type, 0) + 1}) %}
                                                        {% endfor %}
                                                        
                                                        <div class="row">
                                                            {% for type, count in bottleneck_counts.items() %}
                                                                <div class="col-md-6 mb-2">
                                                                    <div class="d-flex justify-content-between align-items-center">
                                                                        <span>
                                                                            {% if type == 'network_congestion' %}
                                                                                <i class="fas fa-exclamation-triangle text-danger me-2"></i>Network Congestion
                                                                            {% elif type == 'server_limited' %}
                                                                                <i class="fas fa-server text-warning me-2"></i>Server Limited
                                                                            {% elif type == 'network_instability' %}
                                                                                <i class="fas fa-wifi text-danger me-2"></i>Network Instability
                                                                            {% elif type == 'packet_loss' %}
                                                                                <i class="fas fa-times-circle text-danger me-2"></i>Packet Loss
                                                                            {% elif type == 'optimal' %}
                                                                                <i class="fas fa-check-circle text-success me-2"></i>Optimal
                                                                            {% else %}
                                                                                <i class="fas fa-question-circle text-muted me-2"></i>{{ type | title | replace('_', ' ') }}
                                                                            {% endif %}
                                                                        </span>
                                                                        <span class="badge bg-primary">{{ count }} clients</span>
                                                                    </div>
                                                                </div>
                                                            {% endfor %}
                                                        </div>
                                                        
                                                        <hr class="my-3">
                                                        <small class="text-muted">
                                                            <strong>Interpretation:</strong>
                                                            <ul class="mb-1">
                                                                <li><strong>Network Congestion:</strong> Multiple congestion events detected - network path is overloaded</li>
                                                                <li><strong>Server Limited:</strong> Server processing is the bottleneck rather than network</li>
                                                                <li><strong>Network Instability:</strong> High RTT variation suggests unstable network conditions</li>
                                                                <li><strong>Packet Loss:</strong> Retransmissions detected - may indicate network issues</li>
                                                                <li><strong>Optimal:</strong> TCP performance is operating efficiently</li>
                                                            </ul>
                                                        </small>
                                                    {% else %}
                                                        <p class="mb-0">No bottleneck analysis data available for this test.</p>
                                                    {% endif %}
                                                </div>
                                            {% else %}
                                                <div class="alert alert-warning">
                                                    <i class="fas fa-info-circle me-2"></i>
                                                    No TCP window analysis data available for this test. This advanced feature requires client version with TCP monitoring capabilities.
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- TCP Handshake Timing Diagnostics -->
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#tcpHandshakeAnalysis">
                                            <i class="fas fa-handshake me-2"></i>TCP Handshake Timing Diagnostics
                                        </button>
                                    </h2>
                                    <div id="tcpHandshakeAnalysis" class="accordion-collapse collapse" data-bs-parent="#metricsAccordion">
                                        <div class="accordion-body">
                                            {% set handshake_results = results | selectattr('tcp_handshake_total_time', 'defined') | list %}
                                            {% if handshake_results %}
                                                <!-- Summary Cards -->
                                                <div class="row mb-4">
                                                    <div class="col-md-6">
                                                        <div class="card bg-primary bg-gradient text-white">
                                                            <div class="card-body text-center">
                                                                {% set avg_total = handshake_results | extract_numeric('tcp_handshake_total_time') %}
                                                                <h4 class="mb-1">{{ "%.2f"|format(avg_total | average) if avg_total else 'N/A' }}ms</h4>
                                                                <p class="mb-0">Average Handshake Time</p>
                                                                <small class="text-light">
                                                                    {% if avg_total and (avg_total | average) < 50 %}
                                                                        Excellent Performance
                                                                    {% elif avg_total and (avg_total | average) < 100 %}
                                                                        Good Performance
                                                                    {% elif avg_total and (avg_total | average) < 200 %}
                                                                        Moderate Performance
                                                                    {% elif avg_total %}
                                                                        Needs Investigation
                                                                    {% else %}
                                                                        No Data
                                                                    {% endif %}
                                                                </small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="card bg-info bg-gradient text-white">
                                                            <div class="card-body text-center">
                                                                {% set avg_server = handshake_results | extract_numeric('tcp_handshake_server_processing') %}
                                                                <h4 class="mb-1">{{ "%.2f"|format(avg_server | average) if avg_server else 'N/A' }}ms</h4>
                                                                <p class="mb-0">Server Processing Time</p>
                                                                <small class="text-light">
                                                                    {% if avg_server and (avg_server | average) < 20 %}
                                                                        Fast Server Response
                                                                    {% elif avg_server and (avg_server | average) < 50 %}
                                                                        Normal Server Response
                                                                    {% elif avg_server %}
                                                                        Slow Server Response
                                                                    {% else %}
                                                                        No Data
                                                                    {% endif %}
                                                                </small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Detailed Handshake Metrics -->
                                                <div class="table-responsive">
                                                    <table class="table table-sm">
                                                        <thead>
                                                            <tr><th>Metric</th><th>Average</th><th>Min</th><th>Max</th><th>Status</th></tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr>
                                                                <td>
                                                                    SYN Packet Time
                                                                    <i class="fas fa-question-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" 
                                                                       title="Time to send initial SYN packet - measures local network stack processing"></i>
                                                                </td>
                                                                {% set syn_times = handshake_results | extract_numeric('tcp_handshake_syn_time') %}
                                                                <td>{{ "%.3f"|format(syn_times | average) if syn_times else 'N/A' }}ms</td>
                                                                <td>{{ "%.3f"|format(syn_times | min) if syn_times else 'N/A' }}ms</td>
                                                                <td>{{ "%.3f"|format(syn_times | max) if syn_times else 'N/A' }}ms</td>
                                                                <td>
                                                                    {% if syn_times and (syn_times | average) < 5 %}
                                                                        <span class="badge bg-success">Fast</span>
                                                                    {% elif syn_times and (syn_times | average) < 20 %}
                                                                        <span class="badge bg-warning">Normal</span>
                                                                    {% elif syn_times %}
                                                                        <span class="badge bg-danger">Slow</span>
                                                                    {% else %}
                                                                        <span class="badge bg-secondary">N/A</span>
                                                                    {% endif %}
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <td>
                                                                    SYN-ACK Response Time
                                                                    <i class="fas fa-question-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" 
                                                                       title="Time to receive SYN-ACK from server - includes network latency and server processing"></i>
                                                                </td>
                                                                {% set synack_times = handshake_results | extract_numeric('tcp_handshake_synack_time') %}
                                                                <td>{{ "%.2f"|format(synack_times | average) if synack_times else 'N/A' }}ms</td>
                                                                <td>{{ "%.2f"|format(synack_times | min) if synack_times else 'N/A' }}ms</td>
                                                                <td>{{ "%.2f"|format(synack_times | max) if synack_times else 'N/A' }}ms</td>
                                                                <td>
                                                                    {% if synack_times and (synack_times | average) < 50 %}
                                                                        <span class="badge bg-success">Excellent</span>
                                                                    {% elif synack_times and (synack_times | average) < 100 %}
                                                                        <span class="badge bg-warning">Good</span>
                                                                    {% elif synack_times %}
                                                                        <span class="badge bg-danger">Poor</span>
                                                                    {% else %}
                                                                        <span class="badge bg-secondary">N/A</span>
                                                                    {% endif %}
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <td>
                                                                    ACK Completion Time
                                                                    <i class="fas fa-question-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" 
                                                                       title="Time to send final ACK packet - completes the three-way handshake"></i>
                                                                </td>
                                                                {% set ack_times = handshake_results | extract_numeric('tcp_handshake_ack_time') %}
                                                                <td>{{ "%.3f"|format(ack_times | average) if ack_times else 'N/A' }}ms</td>
                                                                <td>{{ "%.3f"|format(ack_times | min) if ack_times else 'N/A' }}ms</td>
                                                                <td>{{ "%.3f"|format(ack_times | max) if ack_times else 'N/A' }}ms</td>
                                                                <td>
                                                                    {% if ack_times and (ack_times | average) < 5 %}
                                                                        <span class="badge bg-success">Fast</span>
                                                                    {% elif ack_times and (ack_times | average) < 20 %}
                                                                        <span class="badge bg-warning">Normal</span>
                                                                    {% elif ack_times %}
                                                                        <span class="badge bg-danger">Slow</span>
                                                                    {% else %}
                                                                        <span class="badge bg-secondary">N/A</span>
                                                                    {% endif %}
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <td>
                                                                    Network Delay (Est.)
                                                                    <i class="fas fa-question-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" 
                                                                       title="Estimated one-way network delay based on handshake timing analysis"></i>
                                                                </td>
                                                                {% set network_delays = handshake_results | extract_numeric('tcp_handshake_network_delay') %}
                                                                <td>{{ "%.2f"|format(network_delays | average) if network_delays else 'N/A' }}ms</td>
                                                                <td>{{ "%.2f"|format(network_delays | min) if network_delays else 'N/A' }}ms</td>
                                                                <td>{{ "%.2f"|format(network_delays | max) if network_delays else 'N/A' }}ms</td>
                                                                <td>
                                                                    {% if network_delays and (network_delays | average) < 25 %}
                                                                        <span class="badge bg-success">Low Latency</span>
                                                                    {% elif network_delays and (network_delays | average) < 75 %}
                                                                        <span class="badge bg-warning">Moderate</span>
                                                                    {% elif network_delays %}
                                                                        <span class="badge bg-danger">High Latency</span>
                                                                    {% else %}
                                                                        <span class="badge bg-secondary">N/A</span>
                                                                    {% endif %}
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                                
                                                <!-- Diagnostic Analysis -->
                                                {% set analysis_data = handshake_results | selectattr('tcp_handshake_analysis', 'defined') | list %}
                                                {% if analysis_data %}
                                                    <div class="alert alert-info mt-3">
                                                        <h6 class="alert-heading">
                                                            <i class="fas fa-chart-line me-2"></i>Handshake Performance Analysis
                                                        </h6>
                                                        {% for result in analysis_data[:3] %}
                                                            <p class="mb-1"><strong>Client {{ result.client.name }}:</strong> {{ result.tcp_handshake_analysis }}</p>
                                                        {% endfor %}
                                                        {% if analysis_data | length > 3 %}
                                                            <small class="text-muted">... and {{ analysis_data | length - 3 }} more clients</small>
                                                        {% endif %}
                                                    </div>
                                                {% endif %}
                                                
                                                <hr class="my-3">
                                                <small class="text-muted">
                                                    <strong>Interpretation Guide:</strong>
                                                    <ul class="mb-1">
                                                        <li><strong>SYN Time:</strong> High values indicate local network stack issues or CPU overload</li>
                                                        <li><strong>SYN-ACK Time:</strong> Primary indicator of server response and network latency combined</li>
                                                        <li><strong>ACK Time:</strong> Usually minimal - high values suggest local processing delays</li>
                                                        <li><strong>Network vs Server:</strong> Compare network delay with SYN-ACK time to isolate bottlenecks</li>
                                                    </ul>
                                                </small>
                                            {% else %}
                                                <div class="alert alert-warning">
                                                    <i class="fas fa-info-circle me-2"></i>
                                                    No TCP handshake timing data available for this test. This advanced feature requires the latest client version with handshake diagnostics.
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- System Resources -->
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#systemMetrics">
                                            <i class="fas fa-server me-2"></i>System Resource Metrics
                                        </button>
                                    </h2>
                                    <div id="systemMetrics" class="accordion-collapse collapse" data-bs-parent="#metricsAccordion">
                                        <div class="accordion-body">
                                            <div class="table-responsive">
                                                <table class="table table-sm">
                                                    <thead>
                                                        <tr><th>Metric</th><th>Average</th><th>Status</th></tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr>
                                                            <td>CPU Usage (%)</td>
                                                            {% set avg_cpu = results | extract_numeric('cpu_percent') %}
                                                            <td>{{ "%.1f"|format(avg_cpu | average) if avg_cpu else 'N/A' }}</td>
                                                            <td>
                                                                {% if avg_cpu and (avg_cpu | average) < 70 %}
                                                                    <span class="badge bg-success">Good</span>
                                                                {% elif avg_cpu and (avg_cpu | average) < 90 %}
                                                                    <span class="badge bg-warning">Monitor</span>
                                                                {% elif avg_cpu %}
                                                                    <span class="badge bg-danger">High</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary">N/A</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>Memory Usage (%)</td>
                                                            {% set avg_memory = results | extract_numeric('memory_percent') %}
                                                            <td>{{ "%.1f"|format(avg_memory | average) if avg_memory else 'N/A' }}</td>
                                                            <td>
                                                                {% if avg_memory and (avg_memory | average) < 80 %}
                                                                    <span class="badge bg-success">Good</span>
                                                                {% elif avg_memory and (avg_memory | average) < 95 %}
                                                                    <span class="badge bg-warning">Monitor</span>
                                                                {% elif avg_memory %}
                                                                    <span class="badge bg-danger">High</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary">N/A</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>CPU Load (1min)</td>
                                                            {% set avg_load = results | extract_numeric('cpu_load_1min') %}
                                                            <td>{{ "%.2f"|format(avg_load | average) if avg_load else 'N/A' }}</td>
                                                            <td>
                                                                {% if avg_load and (avg_load | average) < 1 %}
                                                                    <span class="badge bg-success">Low</span>
                                                                {% elif avg_load and (avg_load | average) < 2 %}
                                                                    <span class="badge bg-warning">Moderate</span>
                                                                {% elif avg_load %}
                                                                    <span class="badge bg-danger">High</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary">N/A</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>Process Count</td>
                                                            {% set proc_count = results | extract_numeric('process_count') %}
                                                            <td>{{ proc_count | average | round(0) | int if proc_count else 'N/A' }}</td>
                                                            <td><span class="badge bg-info">Info</span></td>
                                                        </tr>
                                                        <tr>
                                                            <td colspan="3">
                                                                <div class="mt-3">
                                                                    <strong>Top Processes by CPU Usage:</strong>
                                                                    {% set latest_cpu_data = results | selectattr('top_processes_cpu') | first %}
                                                                    {% if latest_cpu_data and latest_cpu_data.top_processes_cpu %}
                                                                        {% set cpu_processes = latest_cpu_data.top_processes_cpu | from_json %}
                                                                        <div class="row mt-2">
                                                                            {% for process in cpu_processes[:5] %}
                                                                                <div class="col-md-6 mb-2">
                                                                                    <div class="card card-body py-2">
                                                                                        <div class="d-flex justify-content-between align-items-center">
                                                                                            <div>
                                                                                                <strong>{{ process.name }}</strong>
                                                                                                <small class="text-muted d-block">PID: {{ process.pid }}</small>
                                                                                            </div>
                                                                                            <div class="text-end">
                                                                                                <span class="badge bg-primary">{{ "%.1f"|format(process.cpu_percent) }}% CPU</span>
                                                                                                <span class="badge bg-secondary">{{ "%.1f"|format(process.memory_percent) }}% RAM</span>
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            {% endfor %}
                                                                        </div>
                                                                    {% else %}
                                                                        <div class="text-muted">No process data available</div>
                                                                    {% endif %}
                                                                </div>
                                                                
                                                                <div class="mt-3">
                                                                    <strong>Top Processes by Memory Usage:</strong>
                                                                    {% set latest_mem_data = results | selectattr('top_processes_memory') | first %}
                                                                    {% if latest_mem_data and latest_mem_data.top_processes_memory %}
                                                                        {% set mem_processes = latest_mem_data.top_processes_memory | from_json %}
                                                                        <div class="row mt-2">
                                                                            {% for process in mem_processes[:5] %}
                                                                                <div class="col-md-6 mb-2">
                                                                                    <div class="card card-body py-2">
                                                                                        <div class="d-flex justify-content-between align-items-center">
                                                                                            <div>
                                                                                                <strong>{{ process.name }}</strong>
                                                                                                <small class="text-muted d-block">PID: {{ process.pid }}</small>
                                                                                            </div>
                                                                                            <div class="text-end">
                                                                                                <span class="badge bg-secondary">{{ "%.1f"|format(process.memory_percent) }}% RAM</span>
                                                                                                <span class="badge bg-primary">{{ "%.1f"|format(process.cpu_percent) }}% CPU</span>
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            {% endfor %}
                                                                        </div>
                                                                    {% else %}
                                                                        <div class="text-muted">No process data available</div>
                                                                    {% endif %}
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Application & Infrastructure -->
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#appMetrics">
                                            <i class="fas fa-globe me-2"></i>Application & Infrastructure Metrics
                                        </button>
                                    </h2>
                                    <div id="appMetrics" class="accordion-collapse collapse" data-bs-parent="#metricsAccordion">
                                        <div class="accordion-body">
                                            <!-- Application & Infrastructure Metrics Info Panel -->
                                            <div class="alert alert-info mb-3">
                                                <div class="row align-items-center">
                                                    <div class="col-md-1 text-center">
                                                        <i class="fas fa-info-circle fa-2x"></i>
                                                    </div>
                                                    <div class="col-md-11">
                                                        <h6 class="alert-heading mb-2">Application & Infrastructure Metrics Collection</h6>
                                                        <p class="mb-2">
                                                            <strong>Collection Window:</strong> Application metrics are collected during the <strong>first 2 intervals</strong> only, 
                                                            Infrastructure metrics during the <strong>first interval</strong> only of each test.
                                                        </p>
                                                        <p class="mb-2">
                                                            <strong>Recommended Settings:</strong> For reliable metric collection, use test duration ≥600 seconds with interval ≥15 seconds.
                                                        </p>
                                                        <p class="mb-0">
                                                            <strong>Requirements:</strong> Linux systems with network access for Application metrics, hardware monitoring files (/sys/class/) for Infrastructure metrics.
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="table-responsive">
                                                <table class="table table-sm">
                                                    <thead>
                                                        <tr><th>Metric</th><th>Value</th><th>Status</th></tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr>
                                                            <td>Content Download Time (ms)</td>
                                                            {% set content_time = results | extract_numeric('content_download_time') %}
                                                            <td>{{ "%.2f"|format(content_time | average) if content_time else 'N/A' }}</td>
                                                            <td>
                                                                {% if content_time and (content_time | average) < 1000 %}
                                                                    <span class="badge bg-success">Fast</span>
                                                                {% elif content_time %}
                                                                    <span class="badge bg-warning">Slow</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary">N/A</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>Compression Ratio (%)</td>
                                                            {% set compress_ratio = results | extract_numeric('compression_ratio') %}
                                                            <td>{{ "%.1f"|format(compress_ratio | average) if compress_ratio else 'N/A' }}</td>
                                                            <td>
                                                                {% if compress_ratio and (compress_ratio | average) > 30 %}
                                                                    <span class="badge bg-success">Good</span>
                                                                {% elif compress_ratio %}
                                                                    <span class="badge bg-warning">Low</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary">N/A</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>Power Consumption (W)</td>
                                                            {% set power_watts = results | extract_numeric('power_consumption_watts') %}
                                                            <td>{{ "%.1f"|format(power_watts | average) if power_watts else 'N/A' }}</td>
                                                            <td>
                                                                {% if power_watts and (power_watts | average) < 150 %}
                                                                    <span class="badge bg-success">Normal</span>
                                                                {% elif power_watts %}
                                                                    <span class="badge bg-warning">High</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary">N/A</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>Memory Error Rate (/hr)</td>
                                                            {% set mem_errors = results | extract_numeric('memory_error_rate') %}
                                                            <td>{{ "%.3f"|format(mem_errors | average) if mem_errors else 'N/A' }}</td>
                                                            <td>
                                                                {% if mem_errors and (mem_errors | average) < 0.1 %}
                                                                    <span class="badge bg-success">Good</span>
                                                                {% elif mem_errors %}
                                                                    <span class="badge bg-warning">Monitor</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary">N/A</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
let testData = {};
let networkChart, cpuChart, memoryChart, diskChart;
let currentMetric = 'ping_latency';

document.addEventListener('DOMContentLoaded', function() {
    loadTestData();
    
    // Initialize Bootstrap tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

async function loadTestData() {
    try {
        console.log('Loading test data from: /api/test/{{ test.id }}/data');
        const response = await fetch(`/api/test/{{ test.id }}/data`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        testData = await response.json();
        console.log('Test data loaded successfully:', testData);
        
        // Check if we have valid data
        if (!testData || !testData.clients || Object.keys(testData.clients).length === 0) {
            console.log('No client data available');
            document.getElementById('avg-latency').textContent = '--';
            document.getElementById('avg-packet-loss').textContent = '--';
            document.getElementById('data-points').textContent = '0';
            return;
        }
        
        try {
            // Initialize charts and update stats
            initializeCharts();
            updateSummaryStats();
            updateClientSummary();
            console.log('All components initialized successfully');
        } catch (error) {
            console.error('Error during component initialization:', error);
        }
        
    } catch (error) {
        console.error('Error loading test data:', error);
        document.getElementById('avg-latency').textContent = '--';
        document.getElementById('avg-packet-loss').textContent = '--';
        document.getElementById('data-points').textContent = '0';
    }
}

function initializeCharts() {
    console.log('Initializing charts with data:', testData);
    
    if (!testData || !testData.clients || !testData.metrics) {
        console.error('Cannot initialize charts: missing data structure');
        return;
    }
    
    // Network Chart
    const networkCtx = document.getElementById('networkChart').getContext('2d');
    
    const colors = ['#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6f42c1'];
    const datasets = Object.keys(testData.clients).map((clientId, index) => {
        const color = colors[index % colors.length];
        const metricData = testData.metrics[currentMetric] && testData.metrics[currentMetric][clientId] 
            ? testData.metrics[currentMetric][clientId] 
            : [];
        
        const validPoints = metricData.filter(p => p && p.y !== null && p.y !== undefined && !isNaN(p.y));
        console.log(`Client ${clientId} (${testData.clients[clientId]}) ${currentMetric}: ${validPoints.length}/${metricData.length} valid points`);
        
        const processedData = metricData.filter(point => point && point.x && point.y !== null).map(point => ({
            x: new Date(point.x),
            y: point.y
        }));
        
        return {
            label: testData.clients[clientId],
            data: processedData,
            borderColor: color,
            backgroundColor: color + '20',
            fill: false,
            tension: 0.1
        };
    });

    networkChart = new Chart(networkCtx, {
        type: 'line',
        data: {
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                title: {
                    display: true,
                    text: getMetricTitle(currentMetric)
                },
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        afterBody: function(context) {
                            const dataIndex = context[0].dataIndex;
                            const clientId = Object.keys(testData.clients)[context[0].datasetIndex];
                            const clientName = testData.clients[clientId];
                            
                            // Add detailed information for troubleshooting
                            let details = [`Client: ${clientName} (ID: ${clientId})`];
                            
                            // Add traceroute data if available for this data point
                            if (testData.metrics.traceroute_data && testData.metrics.traceroute_data[clientId] && 
                                testData.metrics.traceroute_data[clientId][dataIndex]) {
                                const tracerouteData = testData.metrics.traceroute_data[clientId][dataIndex];
                                if (tracerouteData.y) {
                                    try {
                                        const traceData = JSON.parse(tracerouteData.y);
                                        if (traceData && traceData.hops) {
                                            details.push('Traceroute hops:');
                                            traceData.hops.slice(0, 5).forEach((hop, i) => {
                                                details.push(`  ${i+1}. ${hop.ip || hop.host || 'Unknown'} (${hop.rtt || 'N/A'}ms)`);
                                            });
                                            if (traceData.hops.length > 5) {
                                                details.push(`  ... and ${traceData.hops.length - 5} more hops`);
                                            }
                                        }
                                    } catch (e) {
                                        // Ignore JSON parsing errors
                                    }
                                }
                            }
                            
                            return details;
                        }
                    }
                }
            },
            onClick: function(event, elements) {
                if (elements.length > 0) {
                    const dataIndex = elements[0].index;
                    const datasetIndex = elements[0].datasetIndex;
                    const clientId = Object.keys(testData.clients)[datasetIndex];
                    showDataPointDetails(clientId, dataIndex);
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: 'minute',
                        displayFormats: {
                            minute: 'HH:mm',
                            hour: 'HH:mm'
                        }
                    },
                    title: {
                        display: true,
                        text: 'Time'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: getMetricUnit(currentMetric)
                    },
                    beginAtZero: true,
                    ticks: {
                        callback: function(value, index, values) {
                            if (currentMetric === 'bandwidth_upload' || currentMetric === 'bandwidth_download') {
                                return value.toFixed(1) + ' Mbps';
                            }
                            return value;
                        }
                    }
                }
            }
        }
    });

    // System Resource Charts
    initializeResourceCharts();
}

function initializeResourceCharts() {
    if (!testData || !testData.clients || !testData.metrics) {
        console.log('No data available for resource chart initialization');
        return;
    }
    
    const colors = ['#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6f42c1'];
    
    // CPU Chart
    const cpuCtx = document.getElementById('cpuChart').getContext('2d');
    const cpuDatasets = Object.keys(testData.clients).map((clientId, index) => {
        const rawData = (testData.metrics.cpu && testData.metrics.cpu[clientId]) || [];
        const processedData = rawData.filter(point => point && point.x && point.y !== null).map(point => ({
            x: new Date(point.x),
            y: point.y
        }));
        
        return {
            label: testData.clients[clientId],
            data: processedData,
            borderColor: colors[index % colors.length],
            backgroundColor: colors[index % colors.length] + '20',
            fill: false,
            tension: 0.1
        };
    });

    cpuChart = new Chart(cpuCtx, {
        type: 'line',
        data: { datasets: cpuDatasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: 'minute',
                        displayFormats: { minute: 'HH:mm' }
                    }
                },
                y: {
                    title: { display: true, text: 'CPU %' },
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });

    // Memory Chart
    const memoryCtx = document.getElementById('memoryChart').getContext('2d');
    const memoryDatasets = Object.keys(testData.clients).map((clientId, index) => {
        const rawData = (testData.metrics.memory && testData.metrics.memory[clientId]) || [];
        const processedData = rawData.filter(point => point && point.x && point.y !== null).map(point => ({
            x: new Date(point.x),
            y: point.y
        }));
        
        return {
            label: testData.clients[clientId],
            data: processedData,
            borderColor: colors[index % colors.length],
            backgroundColor: colors[index % colors.length] + '20',
            fill: false,
            tension: 0.1
        };
    });

    memoryChart = new Chart(memoryCtx, {
        type: 'line',
        data: { datasets: memoryDatasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: 'minute',
                        displayFormats: { minute: 'HH:mm' }
                    }
                },
                y: {
                    title: { display: true, text: 'Memory %' },
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });

    // Disk Chart
    const diskCtx = document.getElementById('diskChart').getContext('2d');
    const diskDatasets = Object.keys(testData.clients).map((clientId, index) => {
        const rawData = (testData.metrics.disk && testData.metrics.disk[clientId]) || [];
        const processedData = rawData.filter(point => point && point.x && point.y !== null).map(point => ({
            x: new Date(point.x),
            y: point.y
        }));
        
        return {
            label: testData.clients[clientId],
            data: processedData,
            borderColor: colors[index % colors.length],
            backgroundColor: colors[index % colors.length] + '20',
            fill: false,
            tension: 0.1
        };
    });

    diskChart = new Chart(diskCtx, {
        type: 'line',
        data: { datasets: diskDatasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: 'minute',
                        displayFormats: { minute: 'HH:mm' }
                    }
                },
                y: {
                    title: { display: true, text: 'Disk %' },
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
}

function showMetric(metric) {
    currentMetric = metric;
    
    // Update dropdown label and chart title
    document.getElementById('current-metric-label').textContent = getMetricTitle(metric).replace(' Over Time', '');
    document.getElementById('chart-title').innerHTML = '<i class="fas fa-chart-line me-2"></i>' + getMetricTitle(metric);
    
    // Only update chart if it exists and testData is available
    if (networkChart && testData && testData.clients && testData.metrics) {
        const datasets = Object.keys(testData.clients).map((clientId, index) => {
            const colors = ['#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6f42c1'];
            const color = colors[index % colors.length];
            
            // Get raw data and filter out null/undefined values
            let rawData = testData.metrics[metric] && testData.metrics[metric][clientId] ? testData.metrics[metric][clientId] : [];
            
            // For bandwidth metrics, filter out null/zero values and ensure proper data structure
            let filteredData = rawData;
            if (metric === 'bandwidth_upload' || metric === 'bandwidth_download') {
                filteredData = rawData.filter(point => {
                    return point && 
                           point.x && 
                           point.y !== null && 
                           point.y !== undefined && 
                           point.y > 0; // Only show actual bandwidth measurements
                }).map(point => ({
                    x: new Date(point.x),
                    y: parseFloat(point.y)
                }));
            } else {
                // Standard filtering for other metrics
                filteredData = rawData.filter(point => {
                    return point && point.x && point.y !== null && point.y !== undefined;
                }).map(point => ({
                    x: new Date(point.x),
                    y: parseFloat(point.y)
                }));
            }
            
            return {
                label: testData.clients[clientId],
                data: filteredData,
                borderColor: color,
                backgroundColor: color + '20',
                fill: false,
                tension: 0.1,
                spanGaps: false, // Don't connect gaps in bandwidth data
                pointRadius: metric === 'bandwidth_upload' || metric === 'bandwidth_download' ? 4 : 3,
                pointHoverRadius: metric === 'bandwidth_upload' || metric === 'bandwidth_download' ? 6 : 4
            };
        });
        
        networkChart.data.datasets = datasets;
    networkChart.options.plugins.title.text = getMetricTitle(metric);
    networkChart.options.scales.y.title.text = getMetricUnit(metric);
        networkChart.update();
    }
}

function getMetricTitle(metric) {
    const titles = {
        'ping_latency': 'Network Latency Over Time',
        'ping_packet_loss': 'Packet Loss Over Time',
        'jitter': 'Network Jitter Over Time',
        'dns_resolution_time': 'DNS Resolution Time Over Time',
        'tcp_connect_time': 'TCP Connection Time Over Time',
        'ssl_handshake_time': 'SSL Handshake Time Over Time',
        'ttfb': 'Time to First Byte Over Time',
        'cpu_load_1min': 'CPU Load Average (1 minute) Over Time',
        'cpu_load_5min': 'CPU Load Average (5 minutes) Over Time',
        'cpu_load_15min': 'CPU Load Average (15 minutes) Over Time',
        'cpu_freq_current': 'CPU Frequency Over Time',
        'network_bytes_sent': 'Network Bytes Sent Over Time',
        'network_bytes_recv': 'Network Bytes Received Over Time',
        'network_errors_in': 'Network Errors (Incoming) Over Time',
        'network_errors_out': 'Network Errors (Outgoing) Over Time',
        'network_packets_sent': 'Network Packets Sent Over Time',
        'network_packets_recv': 'Network Packets Received Over Time',
        'network_drops_in': 'Network Drops (Incoming) Over Time',
        'network_drops_out': 'Network Drops (Outgoing) Over Time',
        'cpu_cores': 'CPU Core Count Over Time',
        'cpu_temperature': 'CPU Temperature Over Time',
        'process_count': 'Process Count Over Time',
        'tcp_connections': 'TCP Connections Over Time',
        'traceroute_hops': 'Network Path Length Over Time (Hops)',
        'memory_available': 'Memory Available Over Time (GB)',
        'memory_cached': 'Memory Cached Over Time (GB)',
        'memory_buffers': 'Memory Buffers Over Time (GB)',
        'swap_used': 'Swap Used Over Time (GB)',
        'swap_percent': 'Swap Usage Over Time (%)',
        'disk_read_iops': 'Disk Read IOPS Over Time',
        'bandwidth_upload': 'Bandwidth Upload Over Time',
        'bandwidth_download': 'Bandwidth Download Over Time',
        'disk_write_iops': 'Disk Write IOPS Over Time',
        'disk_read_bytes_sec': 'Disk Read Throughput Over Time',
        'disk_write_bytes_sec': 'Disk Write Throughput Over Time',
        'dscp_value': 'DSCP Values Over Time',
        'cos_value': 'CoS Values Over Time',
        'qos_policy_compliant': 'QoS Policy Compliance Over Time'
    };
    return titles[metric] || metric.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}

function getMetricUnit(metric) {
    const units = {
        'ping_latency': 'Latency (ms)',
        'ping_packet_loss': 'Packet Loss (%)',
        'jitter': 'Jitter (ms)',
        'dns_resolution_time': 'DNS Time (ms)',
        'tcp_connect_time': 'Connect Time (ms)',
        'ssl_handshake_time': 'SSL Time (ms)',
        'ttfb': 'TTFB (ms)',
        'cpu_load_1min': 'Load Average',
        'cpu_load_5min': 'Load Average',
        'cpu_load_15min': 'Load Average',
        'cpu_freq_current': 'Frequency (MHz)',
        'network_bytes_sent': 'Bytes',
        'network_bytes_recv': 'Bytes',
        'network_errors_in': 'Error Count',
        'network_errors_out': 'Error Count',
        'network_packets_sent': 'Packets',
        'network_packets_recv': 'Packets',
        'network_drops_in': 'Drop Count',
        'network_drops_out': 'Drop Count',
        'cpu_cores': 'Core Count',
        'cpu_temperature': '°C',
        'process_count': 'Processes',
        'tcp_connections': 'Connections',
        'memory_available': 'Bytes',
        'memory_cached': 'Bytes',
        'memory_buffers': 'Bytes',
        'swap_percent': 'Percent (%)',
        'traceroute_hops': 'Hops',
        'disk_read_iops': 'Operations/sec',
        'disk_write_iops': 'Operations/sec',
        'disk_read_bytes_sec': 'Bytes/sec',
        'disk_write_bytes_sec': 'Bytes/sec',
        'dscp_value': 'DSCP Code',
        'cos_value': 'CoS Value',
        'qos_policy_compliant': 'Compliance (0/1)',
        'bandwidth_upload': 'Upload Speed (Mbps)',
        'bandwidth_download': 'Download Speed (Mbps)'
    };
    return units[metric] || 'Value';
}

function updateSummaryStats() {
    console.log('Updating summary stats with data:', testData);
    
    if (!testData || !testData.clients || !testData.metrics) {
        console.log('Missing data structure for summary stats');
        document.getElementById('avg-latency').textContent = '--';
        document.getElementById('avg-packet-loss').textContent = '--';
        document.getElementById('data-points').textContent = '0';
        return;
    }
    
    // Calculate average latency and packet loss
    let totalLatency = 0;
    let totalPacketLoss = 0;
    let latencyCount = 0;
    let packetLossCount = 0;
    let totalCpu = 0;
    let cpuCount = 0;
    let totalDataPoints = 0;
    
    Object.keys(testData.clients).forEach(clientId => {
        const latencyData = (testData.metrics.ping_latency && testData.metrics.ping_latency[clientId]) || [];
        const packetLossData = (testData.metrics.ping_packet_loss && testData.metrics.ping_packet_loss[clientId]) || [];
        const cpuData = (testData.metrics.cpu && testData.metrics.cpu[clientId]) || [];
        
        // Count total data points from any metric
        totalDataPoints += Math.max(latencyData.length, cpuData.length, packetLossData.length);
        
        latencyData.forEach(point => {
            if (point && point.y !== null && point.y !== undefined && !isNaN(point.y)) {
                totalLatency += point.y;
                latencyCount++;
            }
        });
        
        packetLossData.forEach(point => {
            if (point && point.y !== null && point.y !== undefined && !isNaN(point.y)) {
                totalPacketLoss += point.y;
                packetLossCount++;
            }
        });
        
        cpuData.forEach(point => {
            if (point && point.y !== null && point.y !== undefined && !isNaN(point.y)) {
                totalCpu += point.y;
                cpuCount++;
            }
        });
    });
    
    // Update displays with actual data or appropriate messages
    const avgLatency = latencyCount > 0 ? (totalLatency / latencyCount).toFixed(1) : '--';
    const avgPacketLoss = packetLossCount > 0 ? (totalPacketLoss / packetLossCount).toFixed(1) : '--';
    const avgCpu = cpuCount > 0 ? (totalCpu / cpuCount).toFixed(1) : '--';
    
    // Update summary cards
    document.getElementById('data-points').textContent = totalDataPoints;
    document.getElementById('avg-latency').textContent = avgLatency + (avgLatency !== '--' ? ' ms' : '');
    document.getElementById('avg-packet-loss').textContent = avgPacketLoss + (avgPacketLoss !== '--' ? '%' : '');
    
    console.log(`Stats calculated: ${latencyCount} latency points, ${cpuCount} CPU points, ${packetLossCount} packet loss points, ${totalDataPoints} total data points`);
}

function updateClientSummary() {
    if (!testData || !testData.clients || !testData.metrics) {
        return;
    }
    
    Object.keys(testData.clients).forEach(clientId => {
        const latencyData = (testData.metrics.ping_latency && testData.metrics.ping_latency[clientId]) || [];
        const packetLossData = (testData.metrics.ping_packet_loss && testData.metrics.ping_packet_loss[clientId]) || [];
        const cpuData = (testData.metrics.cpu && testData.metrics.cpu[clientId]) || [];
        const memoryData = (testData.metrics.memory && testData.metrics.memory[clientId]) || [];
        const diskData = (testData.metrics.disk && testData.metrics.disk[clientId]) || [];
        
        // Calculate averages
        const avgLatency = calculateAverage(latencyData);
        const avgPacketLoss = calculateAverage(packetLossData);
        const avgCpu = calculateAverage(cpuData);
        const avgMemory = calculateAverage(memoryData);
        const avgDisk = calculateAverage(diskData);
        
        // Update table cells
        const dataPointsCell = document.querySelector(`[data-client="${clientId}"].client-data-points`);
        const latencyCell = document.querySelector(`[data-client="${clientId}"].client-avg-latency`);
        const packetLossCell = document.querySelector(`[data-client="${clientId}"].client-avg-packet-loss`);
        const cpuCell = document.querySelector(`[data-client="${clientId}"].client-avg-cpu`);
        const memoryCell = document.querySelector(`[data-client="${clientId}"].client-avg-memory`);
        const diskCell = document.querySelector(`[data-client="${clientId}"].client-avg-disk`);
        
        if (dataPointsCell) dataPointsCell.textContent = latencyData.length;
        if (latencyCell) latencyCell.textContent = avgLatency !== null ? avgLatency.toFixed(1) + ' ms' : '--';
        if (packetLossCell) packetLossCell.textContent = avgPacketLoss !== null ? avgPacketLoss.toFixed(1) + '%' : '--';
        if (cpuCell) cpuCell.textContent = avgCpu !== null ? avgCpu.toFixed(1) + '%' : '--';
        if (memoryCell) memoryCell.textContent = avgMemory !== null ? avgMemory.toFixed(1) + '%' : '--';
        if (diskCell) diskCell.textContent = avgDisk !== null ? avgDisk.toFixed(1) + '%' : '--';
    });
}

function calculateAverage(dataPoints) {
    const validPoints = dataPoints.filter(point => point.y !== null && point.y !== undefined);
    if (validPoints.length === 0) return null;
    
    const sum = validPoints.reduce((acc, point) => acc + point.y, 0);
    return sum / validPoints.length;
}

// Auto-refresh data every 30 seconds for running tests
{% if test.status == 'running' %}
setInterval(loadTestData, 30000);
{% endif %}

function exportPDF(testId) {
    // Show loading state
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Generating PDF...';
    btn.disabled = true;
    
    // Create a temporary link to download the PDF
    const link = document.createElement('a');
    link.href = `/api/test/${testId}/export/pdf`;
    link.download = '';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Restore button after a delay
    setTimeout(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
        showToast('PDF report download started', 'success');
    }, 2000);
}

function showDataPointDetails(clientId, dataIndex) {
    const clientName = testData.clients[clientId];
    const timestamp = testData.metrics[currentMetric] && testData.metrics[currentMetric][clientId] && 
                     testData.metrics[currentMetric][clientId][dataIndex] ? 
                     testData.metrics[currentMetric][clientId][dataIndex].x : 'Unknown';
    
    let modalContent = `
        <div class="modal fade" id="dataPointModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-search me-2"></i>
                            Data Point Details - ${clientName}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <strong>Client:</strong> ${clientName} (ID: ${clientId})
                            </div>
                            <div class="col-md-4">
                                <strong>Timestamp:</strong> ${new Date(timestamp).toLocaleString()}
                            </div>
                            <div class="col-md-4" id="currentHopInfo">
                                <strong>Current Network Hop:</strong> <span id="hopNumber">Analyzing...</span>
                            </div>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6>Metrics at this time point:</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped">
                                        <thead>
                                            <tr>
                                                <th>Metric</th>
                                                <th>Value</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="metricsTable">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row" id="tracerouteSection" style="display: none;">
                            <div class="col-12">
                                <h6>Network Path Analysis:</h6>
                                <div class="alert alert-info mb-3" id="hopAnalysis" style="display: none;">
                                    <i class="fas fa-route me-2"></i>
                                    <span id="hopAnalysisText"></span>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Hop</th>
                                                <th>IP/Host</th>
                                                <th>RTT (ms)</th>
                                                <th>Status</th>
                                                <th>Analysis</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tracerouteTable">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="exportDataPoint('${clientId}', ${dataIndex})">
                            <i class="fas fa-download me-1"></i>Export Details
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if present
    const existingModal = document.getElementById('dataPointModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to DOM
    document.body.insertAdjacentHTML('beforeend', modalContent);
    
    // Populate metrics table
    const metricsTable = document.getElementById('metricsTable');
    const metricNames = [
        'ping_latency', 'ping_packet_loss', 'jitter', 'dns_resolution_time', 'tcp_connect_time',
        'ssl_handshake_time', 'ttfb', 'cpu', 'memory', 'disk', 'network_bytes_sent', 'network_bytes_recv'
    ];
    
    metricNames.forEach(metric => {
        if (testData.metrics[metric] && testData.metrics[metric][clientId] && 
            testData.metrics[metric][clientId][dataIndex]) {
            const value = testData.metrics[metric][clientId][dataIndex].y;
            if (value !== null && value !== undefined) {
                const row = document.createElement('tr');
                const status = getMetricStatus(metric, value);
                row.innerHTML = `
                    <td>${getMetricDisplayName(metric)}</td>
                    <td>${formatMetricValue(metric, value)}</td>
                    <td><span class="badge bg-${status.color}">${status.text}</span></td>
                `;
                metricsTable.appendChild(row);
            }
        }
    });
    

    
    // Populate traceroute table and analyze network hops if available
    if (testData.metrics.traceroute_data && testData.metrics.traceroute_data[clientId] && 
        testData.metrics.traceroute_data[clientId][dataIndex]) {
        const tracerouteData = testData.metrics.traceroute_data[clientId][dataIndex];
        if (tracerouteData.y) {
            try {
                // Parse the traceroute data - it's stored as an array of strings
                const rawTraceData = JSON.parse(tracerouteData.y);
                
                // Convert the array of strings to hop objects
                const hops = [];
                if (Array.isArray(rawTraceData)) {
                    rawTraceData.forEach((hopLine, index) => {
                        const hop = parseTracerouteHop(hopLine, index);
                        if (hop) {
                            hops.push(hop);
                        }
                    });
                }
                
                if (hops.length > 0) {
                    document.getElementById('tracerouteSection').style.display = 'block';
                    const tracerouteTable = document.getElementById('tracerouteTable');
                    
                    // Analyze current performance metrics to identify problem hop
                    const currentLatency = testData.metrics.ping_latency && testData.metrics.ping_latency[clientId] && 
                                         testData.metrics.ping_latency[clientId][dataIndex] ? 
                                         testData.metrics.ping_latency[clientId][dataIndex].y : null;
                    
                    const currentJitter = testData.metrics.jitter && testData.metrics.jitter[clientId] && 
                                        testData.metrics.jitter[clientId][dataIndex] ? 
                                        testData.metrics.jitter[clientId][dataIndex].y : null;
                    
                    let problemHop = analyzeProblemHop(hops, currentLatency, currentJitter);
                    
                    // Update current hop info
                    const hopNumberElement = document.getElementById('hopNumber');
                    if (problemHop.hopIndex !== -1) {
                        hopNumberElement.innerHTML = `<span class="badge bg-${problemHop.severity}">${problemHop.hopIndex + 1}</span> ${problemHop.description}`;
                        
                        // Show analysis alert
                        document.getElementById('hopAnalysis').style.display = 'block';
                        document.getElementById('hopAnalysisText').textContent = problemHop.analysis;
                    } else {
                        hopNumberElement.textContent = 'All hops performing normally';
                    }
                    
                    hops.forEach((hop, index) => {
                        const row = document.createElement('tr');
                        const rtt = hop.rtt || 'Timeout';
                        const status = hop.rtt ? (hop.rtt > 100 ? 'warning' : 'success') : 'danger';
                        const statusText = hop.rtt ? (hop.rtt > 100 ? 'Slow' : 'Good') : 'Timeout';
                        
                        // Add special highlighting for problem hop
                        const isProbleHop = index === problemHop.hopIndex;
                        const rowClass = isProbleHop ? 'table-warning' : '';
                        
                        // Analyze this specific hop
                        let hopAnalysis = analyzeIndividualHop(hop, index, hops);
                        
                        row.className = rowClass;
                        row.innerHTML = `
                            <td>${hop.hopNumber}${isProbleHop ? ' <i class="fas fa-exclamation-triangle text-warning"></i>' : ''}</td>
                            <td>${hop.host || hop.ip || 'Unknown'}</td>
                            <td>${rtt}</td>
                            <td><span class="badge bg-${status}">${statusText}</span></td>
                            <td><small class="text-muted">${hopAnalysis}</small></td>
                        `;
                        tracerouteTable.appendChild(row);
                    });
                }
            } catch (e) {
                console.error('Error parsing traceroute data:', e);
            }
        }
    } else {
        // No traceroute data available, but still show basic hop analysis
        document.getElementById('hopNumber').textContent = 'Traceroute data not available';
    }
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('dataPointModal'));
    modal.show();
}

function getMetricDisplayName(metric) {
    const names = {
        'ping_latency': 'Network Latency',
        'ping_packet_loss': 'Packet Loss',
        'jitter': 'Network Jitter',
        'dns_resolution_time': 'DNS Resolution',
        'tcp_connect_time': 'TCP Connect',
        'ssl_handshake_time': 'SSL Handshake',
        'ttfb': 'Time to First Byte',
        'cpu': 'CPU Usage',
        'memory': 'Memory Usage',
        'disk': 'Disk Usage',
        'network_bytes_sent': 'Bytes Sent',
        'network_bytes_recv': 'Bytes Received'
    };
    return names[metric] || metric;
}

function formatMetricValue(metric, value) {
    if (metric.includes('latency') || metric.includes('time') || metric === 'jitter' || metric === 'ttfb') {
        return `${value.toFixed(2)} ms`;
    } else if (metric.includes('packet_loss') || metric === 'cpu' || metric === 'memory' || metric === 'disk') {
        return `${value.toFixed(1)}%`;
    } else if (metric.includes('bytes')) {
        return formatBytes(value);
    }
    return value.toString();
}

function getMetricStatus(metric, value) {
    if (metric === 'ping_latency' || metric === 'jitter') {
        if (value < 50) return { color: 'success', text: 'Excellent' };
        if (value < 150) return { color: 'warning', text: 'Good' };
        return { color: 'danger', text: 'Poor' };
    } else if (metric === 'ping_packet_loss') {
        if (value === 0) return { color: 'success', text: 'Excellent' };
        if (value < 1) return { color: 'warning', text: 'Acceptable' };
        return { color: 'danger', text: 'Poor' };
    } else if (metric === 'cpu' || metric === 'memory' || metric === 'disk') {
        if (value < 70) return { color: 'success', text: 'Normal' };
        if (value < 90) return { color: 'warning', text: 'High' };
        return { color: 'danger', text: 'Critical' };
    } else if (metric.includes('time') || metric === 'ttfb') {
        if (value < 100) return { color: 'success', text: 'Fast' };
        if (value < 500) return { color: 'warning', text: 'Moderate' };
        return { color: 'danger', text: 'Slow' };
    }
    return { color: 'secondary', text: 'Info' };
}

function parseTracerouteHop(hopLine, index) {
    // Parse traceroute hop line like: "1  _gateway (172.16.10.253)  3.744 ms  3.836 ms  3.804 ms"
    if (!hopLine || hopLine.trim() === '' || hopLine.includes('* * *')) {
        return { hopNumber: index + 1, ip: null, host: null, rtt: null };
    }
    
    try {
        // Extract IP address - look for patterns like (192.168.1.1)
        const ipMatch = hopLine.match(/\(([^)]+)\)/);
        const ip = ipMatch ? ipMatch[1] : null;
        
        // Extract hostname - text before the IP address
        let host = null;
        if (ipMatch) {
            const beforeIp = hopLine.split('(')[0].trim();
            const parts = beforeIp.split(/\s+/);
            if (parts.length > 1) {
                host = parts[parts.length - 1];
            }
        }
        
        // Extract RTT - look for the first "X.XXX ms" pattern
        const rttMatch = hopLine.match(/(\d+\.?\d*)\s*ms/);
        const rtt = rttMatch ? parseFloat(rttMatch[1]) : null;
        
        return {
            hopNumber: index + 1,
            ip: ip,
            host: host || ip || 'Unknown',
            rtt: rtt
        };
    } catch (e) {
        return { hopNumber: index + 1, ip: null, host: 'Parse Error', rtt: null };
    }
}

function analyzeProblemHop(hops, currentLatency, currentJitter) {
    let result = { hopIndex: -1, severity: 'success', description: 'All hops normal', analysis: '' };
    
    if (!hops || hops.length === 0) return result;
    
    // Look for significant RTT increases between consecutive hops
    let maxRttIncrease = 0;
    let problemHopIndex = -1;
    let previousRtt = 0;
    
    hops.forEach((hop, index) => {
        if (hop.rtt && hop.rtt > 0) {
            if (index > 0 && previousRtt > 0) {
                const increase = hop.rtt - previousRtt;
                if (increase > maxRttIncrease && increase > 50) { // Significant increase threshold
                    maxRttIncrease = increase;
                    problemHopIndex = index;
                }
            }
            previousRtt = hop.rtt;
        }
    });
    
    // Check for timeouts or very high latency
    hops.forEach((hop, index) => {
        if (!hop.rtt || hop.rtt > 500) {
            if (problemHopIndex === -1 || maxRttIncrease < 200) {
                problemHopIndex = index;
                maxRttIncrease = hop.rtt || 1000;
            }
        }
    });
    
    if (problemHopIndex !== -1) {
        const problemHop = hops[problemHopIndex];
        result.hopIndex = problemHopIndex;
        
        if (!problemHop.rtt) {
            result.severity = 'danger';
            result.description = `${problemHop.ip || problemHop.host || 'Unknown'} (Timeout)`;
            result.analysis = `Hop ${problemHopIndex + 1} is experiencing timeouts, which may indicate packet loss or filtering.`;
        } else if (problemHop.rtt > 500) {
            result.severity = 'danger';
            result.description = `${problemHop.ip || problemHop.host || 'Unknown'} (${problemHop.rtt}ms)`;
            result.analysis = `Hop ${problemHopIndex + 1} has very high latency (${problemHop.rtt}ms), indicating a bottleneck.`;
        } else if (maxRttIncrease > 100) {
            result.severity = 'warning';
            result.description = `${problemHop.ip || problemHop.host || 'Unknown'} (+${maxRttIncrease.toFixed(1)}ms)`;
            result.analysis = `Hop ${problemHopIndex + 1} shows a significant latency increase of ${maxRttIncrease.toFixed(1)}ms from the previous hop.`;
        }
    }
    
    return result;
}

function analyzeIndividualHop(hop, index, allHops) {
    if (!hop.rtt) return 'Timeout or filtered';
    
    if (hop.rtt > 500) return 'Very high latency';
    if (hop.rtt > 200) return 'High latency';
    
    // Check if this hop has a significant increase from previous
    if (index > 0 && allHops[index - 1] && allHops[index - 1].rtt) {
        const increase = hop.rtt - allHops[index - 1].rtt;
        if (increase > 100) return `+${increase.toFixed(1)}ms increase`;
        if (increase > 50) return `+${increase.toFixed(1)}ms rise`;
    }
    
    // Classify by RTT range
    if (hop.rtt < 10) return 'Excellent';
    if (hop.rtt < 50) return 'Good';
    if (hop.rtt < 100) return 'Acceptable';
    return 'Slow';
}

function exportDataPoint(clientId, dataIndex) {
    // Create detailed export data
    const clientName = testData.clients[clientId];
    const timestamp = testData.metrics[currentMetric][clientId][dataIndex].x;
    
    let exportData = {
        client: { id: clientId, name: clientName },
        timestamp: timestamp,
        metrics: {},
        networkPath: null
    };
    
    // Collect all available metrics for this data point
    Object.keys(testData.metrics).forEach(metric => {
        if (testData.metrics[metric][clientId] && testData.metrics[metric][clientId][dataIndex]) {
            exportData.metrics[metric] = testData.metrics[metric][clientId][dataIndex].y;
        }
    });
    
    // Include traceroute data if available
    if (testData.metrics.traceroute_data && testData.metrics.traceroute_data[clientId] && 
        testData.metrics.traceroute_data[clientId][dataIndex]) {
        try {
            const rawTraceData = JSON.parse(testData.metrics.traceroute_data[clientId][dataIndex].y);
            const hops = [];
            if (Array.isArray(rawTraceData)) {
                rawTraceData.forEach((hopLine, index) => {
                    const hop = parseTracerouteHop(hopLine, index);
                    if (hop) {
                        hops.push(hop);
                    }
                });
            }
            exportData.networkPath = { hops: hops, raw: rawTraceData };
        } catch (e) {
            exportData.networkPath = { error: 'Failed to parse traceroute data' };
        }
    }
    
    // Download as JSON file
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `datapoint_${clientName}_${timestamp.replace(/[:.]/g, '-')}.json`;
    a.click();
    URL.revokeObjectURL(url);
}
</script>
{% endblock %}
